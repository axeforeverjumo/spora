<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit sale.order form to add segments tab and smart button -->
    <record id="sale_order_view_form_inherit_segment" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.segment</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">

            <!-- Add smart button to header -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_segments"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-sitemap"
                        invisible="segment_count == 0">
                    <field name="segment_count" widget="statinfo" string="Vista JerÃ¡rquica"/>
                </button>
            </xpath>

            <!-- Add segments tab to notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Segments" name="segments">
                    <field name="segment_ids" context="{'default_order_id': id}">
                        <list>
                            <field name="sequence" widget="handle"/>
                            <field name="name"/>
                            <field name="parent_id" domain="[('order_id', '=', parent.id)]"/>
                            <field name="level" readonly="1"/>
                            <field name="subtotal" sum="Subtotal"/>
                            <field name="total" sum="Total"/>
                        </list>
                    </field>
                </page>
            </xpath>

        </field>
    </record>

    <!-- Inherit sale.order form to add segment_id to order line inline tree -->
    <record id="sale_order_line_view_tree_inherit_segment" model="ir.ui.view">
        <field name="name">sale.order.line.tree.inherit.segment</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='order_line']//list//field[@name='product_id']" position="after">
                <field name="segment_id" optional="hide"/>
            </xpath>
        </field>
    </record>

</odoo>
