---
phase: 02-sale-order-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - addons/spora_segment/tests/__init__.py
  - addons/spora_segment/tests/test_sale_order_integration.py
autonomous: true

must_haves:
  truths:
    - "Segment subtotal equals sum of directly assigned order line price_subtotals"
    - "Segment total equals own subtotal plus recursive sum of children totals"
    - "Cannot assign order line to segment from a different sale order"
    - "Cannot set parent segment from a different sale order"
    - "Smart button segment_count matches actual number of segments on order"
    - "Creating segment from sale order context auto-populates order_id"
  artifacts:
    - path: "addons/spora_segment/tests/test_sale_order_integration.py"
      provides: "Integration test suite covering SALE-01 through SALE-11"
      contains: "TestSaleOrderSegmentIntegration"
      min_lines: 150
  key_links:
    - from: "addons/spora_segment/tests/test_sale_order_integration.py"
      to: "sale.order, sale.order.line, sale.order.segment models"
      via: "TransactionCase creating orders, lines, segments and asserting computed values"
      pattern: "self\\.env\\['sale\\.order"
---

<objective>
Write and execute comprehensive integration tests validating all SALE-01 through SALE-11 requirements: segment-to-order relationships, order-line-to-segment assignment, computed subtotals and recursive totals, cross-order constraints, and smart button behavior.

Purpose: Verify that the Phase 2 model extensions and views work correctly together, providing regression protection for future phases that build on this integration.

Output: A test file with 15+ test methods covering all requirements, all passing on Odoo 18 Docker.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sale-order-integration/02-RESEARCH.md
@.planning/phases/02-sale-order-integration/02-01-SUMMARY.md
@addons/spora_segment/models/sale_order_segment.py
@addons/spora_segment/models/sale_order.py
@addons/spora_segment/models/sale_order_line.py
@addons/spora_segment/tests/test_sale_order_segment.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write integration tests for SALE-01 through SALE-11</name>
  <files>
    addons/spora_segment/tests/test_sale_order_integration.py
    addons/spora_segment/tests/__init__.py
  </files>
  <action>
    **1. Update `addons/spora_segment/tests/__init__.py`:**

    Add `from . import test_sale_order_integration` alongside existing import.

    **2. Create `addons/spora_segment/tests/test_sale_order_integration.py`:**

    Use `@tagged('post_install', '-at_install')` since these tests require sale module data and full module installation.

    Use `TransactionCase` base class with `setUpClass` creating shared test data:
    - `cls.partner = cls.env['res.partner'].create({'name': 'Test Customer'})`
    - `cls.product_a = cls.env['product.product'].create({'name': 'Product A', 'list_price': 100.0})`
    - `cls.product_b = cls.env['product.product'].create({'name': 'Product B', 'list_price': 200.0})`
    - `cls.product_c = cls.env['product.product'].create({'name': 'Product C', 'list_price': 50.0})`

    **Test methods (one per requirement + edge cases):**

    **SALE-01: Sale order has segment_ids**
    - `test_sale_order_has_segment_ids`: Create order, create 2 segments with that order_id. Assert `len(order.segment_ids) == 2`. Assert both segment IDs in `order.segment_ids.ids`.

    **SALE-02: Sale order line has segment_id**
    - `test_sale_order_line_has_segment_id`: Create order, segment, and order line with `segment_id=segment.id`. Assert `line.segment_id.id == segment.id`.
    - `test_sale_order_line_segment_optional`: Create order line WITHOUT segment_id. Assert `line.segment_id` is falsy (not required field).

    **SALE-04/05: Create segment with parent from sale order**
    - `test_create_segment_with_parent_same_order`: Create order, root segment, child segment (both same order_id). Assert child.parent_id == root. No error.
    - `test_create_segment_cross_order_parent_blocked`: Create order1, order2, segment on order1. Create segment on order2 with parent_id=order1_segment. Assert raises `ValidationError`.

    **SALE-06: Assign products to segments**
    - `test_assign_line_to_segment`: Create order, segment, line with segment_id. Assert line appears in `segment.line_ids`.
    - `test_assign_line_cross_order_blocked`: Create order1 with segment, order2. Create line on order2 with segment from order1. Assert raises `ValidationError`.

    **SALE-07: Subtotal computation**
    - `test_segment_subtotal_sum_of_lines`: Create segment, add 2 lines (Product A qty=2 -> 200, Product B qty=1 -> 200). Assert `segment.subtotal == 400.0`.
    - `test_segment_subtotal_zero_no_lines`: Create segment with no lines. Assert `segment.subtotal == 0.0`.
    - `test_segment_subtotal_updates_on_line_change`: Create segment with line (qty=1, price=100). Change qty to 3. Assert subtotal updates to 300.

    **SALE-08: Total computation (recursive)**
    - `test_segment_total_no_children`: Create segment with lines. Assert `segment.total == segment.subtotal`.
    - `test_segment_total_includes_children`: Create parent (1 line: 100) and child (1 line: 200). Assert `parent.total == 300` (100 + 200). Assert `child.total == 200`.
    - `test_segment_total_three_levels`: Create grandparent, parent, child with lines at each level. Verify totals propagate correctly up the hierarchy. Example: grandparent(50) + parent(100) + child(200) = grandparent.total should be 350.
    - `test_segment_total_updates_cascade`: Create parent+child, add line to child. Verify parent.total increases.

    **SALE-11: Smart button segment_count**
    - `test_segment_count_zero`: New order with no segments. Assert `order.segment_count == 0`.
    - `test_segment_count_reflects_all_segments`: Create 3 segments (including children). Assert `order.segment_count == 3` (counts all segments, not just roots).
    - `test_action_view_segments_returns_action`: Call `order.action_view_segments()`. Assert return dict has `type='ir.actions.act_window'`, `res_model='sale.order.segment'`, `domain` contains order ID filter.

    **Edge case: order_id required**
    - `test_segment_requires_order_id`: Creating segment without order_id raises error (IntegrityError or ValidationError depending on Odoo behavior for required field).

    **IMPORTANT test patterns (from Phase 1 learnings):**
    - Use `self.assertRaises(ValidationError)` for constraint violations
    - Create each order fresh per test method (don't share mutable order state across tests)
    - After modifying lines, the stored computed field should recompute automatically. If not, call `segment.invalidate_recordset()` then re-read.
    - For price calculations, use `price_subtotal` field on sale.order.line (computed by Odoo from `product_uom_qty * price_unit`).

    **What to avoid:**
    - Do NOT test view rendering (XML) in Python tests. Views are tested by module update + visual check.
    - Do NOT test expand/collapse (SALE-10) -- this is UI behavior verified visually.
    - Do NOT use `Form()` helper unless absolutely necessary (adds complexity). Direct create/write is sufficient.
  </action>
  <verify>
    Run Python syntax check:
    ```bash
    python3 -c "import ast; ast.parse(open('addons/spora_segment/tests/test_sale_order_integration.py').read()); print('Test file parses OK')"
    ```

    Verify test class has at least 15 test methods:
    ```bash
    grep -c "def test_" addons/spora_segment/tests/test_sale_order_integration.py
    ```
  </verify>
  <done>
    - test_sale_order_integration.py created with 15+ test methods
    - Tests cover all SALE requirements (01-09, 11) except SALE-10 (UI-only)
    - __init__.py updated with new test module import
    - Python syntax validates correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute tests in Docker and fix any failures</name>
  <files>
    addons/spora_segment/tests/test_sale_order_integration.py
    addons/spora_segment/models/sale_order_segment.py
    addons/spora_segment/models/sale_order.py
    addons/spora_segment/models/sale_order_line.py
  </files>
  <action>
    **1. Update the module in Docker first:**
    ```bash
    docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init
    ```

    If module update fails, fix the issue (likely XML or model error) before proceeding to tests.

    **2. Run the integration tests via Odoo shell (proven method from Phase 1):**
    ```bash
    docker compose exec odoo odoo shell -d spora --no-http <<'EOF'
    import unittest
    from odoo.tests.common import TransactionCase
    loader = unittest.TestLoader()
    suite = loader.loadTestsFromName('odoo.addons.spora_segment.tests.test_sale_order_integration')
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    EOF
    ```

    **3. Also run the existing Phase 1 tests to check for regressions:**
    ```bash
    docker compose exec odoo odoo shell -d spora --no-http <<'EOF'
    import unittest
    loader = unittest.TestLoader()
    suite = loader.loadTestsFromName('odoo.addons.spora_segment.tests.test_sale_order_segment')
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    EOF
    ```

    **4. Fix failures iteratively:**

    For each failing test:
    1. Read the error message carefully
    2. Determine if the issue is in the test (wrong assertion) or the model (bug)
    3. Fix the code
    4. Re-run the specific failing test
    5. When all individual tests pass, run full suite again

    **Common failure patterns from Phase 1 experience:**
    - Exception type mismatch: Odoo may raise UserError/IntegrityError instead of ValidationError for some constraints. Adjust assertRaises accordingly.
    - Computed field not recomputing: If stored computed field shows stale value, try `record.invalidate_recordset(['field_name'])` then re-read. If that doesn't work, check `@api.depends` is correct.
    - price_subtotal not computed: sale.order.line computes `price_subtotal` from `product_uom_qty * price_unit`. May need to set `price_unit` explicitly or trigger `_compute_amount` after create.
    - Module installation may alter existing test data if Phase 1 tests created segments without order_id (now required). Fix Phase 1 test setUpClass if needed.

    **5. Verify all tests pass (both new and existing):**
    Run both test suites. All tests should pass with 0 failures and 0 errors.

    **What to avoid:**
    - Do NOT skip or delete Phase 1 tests. They must continue to pass (regression protection).
    - Do NOT ignore warnings in test output -- they may indicate deprecation or configuration issues.
  </action>
  <verify>
    Both test suites pass:
    - `test_sale_order_segment.py`: 26 tests, 0 failures, 0 errors
    - `test_sale_order_integration.py`: 15+ tests, 0 failures, 0 errors

    Module update completes without errors:
    ```bash
    docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init 2>&1 | grep -i error
    ```
    (Should show no errors)
  </verify>
  <done>
    - All integration tests pass (0 failures, 0 errors)
    - All Phase 1 tests still pass (no regressions)
    - Module installs/updates cleanly in Docker
    - Any discovered bugs have been fixed and committed
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Full test suite:** Both `test_sale_order_segment` (26 tests) and `test_sale_order_integration` (15+ tests) pass with 0 failures
2. **No regressions:** Phase 1 hierarchy tests unaffected by Phase 2 changes
3. **Module update:** Clean update in Docker without errors
4. **Requirement coverage:** Every SALE requirement (except SALE-10 UI-only) has at least one test
</verification>

<success_criteria>
- test_sale_order_integration.py contains 15+ test methods
- All tests pass on Odoo 18 Docker (0 failures, 0 errors)
- Phase 1 tests still pass (no regressions)
- Tests cover: segment_ids relationship, segment_id on lines, subtotal computation, recursive total computation, cross-order constraints, smart button count, action method return
- Any bugs discovered during testing are fixed in model/view code
</success_criteria>

<output>
After completion, create `.planning/phases/02-sale-order-integration/02-02-SUMMARY.md`
</output>
