---
phase: 02-sale-order-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/spora_segment/models/__init__.py
  - addons/spora_segment/models/sale_order.py
  - addons/spora_segment/models/sale_order_line.py
  - addons/spora_segment/models/sale_order_segment.py
  - addons/spora_segment/views/sale_order_views.xml
  - addons/spora_segment/views/sale_order_segment_views.xml
  - addons/spora_segment/__manifest__.py
autonomous: true

must_haves:
  truths:
    - "User can create segments directly from the sale order form via a Segments tab"
    - "User can assign an order line (product) to a specific segment via segment_id dropdown"
    - "System displays subtotal for each segment (sum of direct order line prices)"
    - "System displays total for each segment (own subtotal + recursive children totals)"
    - "Smart button on sale order shows segment count and opens filtered segment view"
    - "Segment parent_id dropdown only shows segments from the same sale order"
  artifacts:
    - path: "addons/spora_segment/models/sale_order.py"
      provides: "sale.order extension with segment_ids, segment_count, action_view_segments"
      contains: "_inherit = 'sale.order'"
    - path: "addons/spora_segment/models/sale_order_line.py"
      provides: "sale.order.line extension with segment_id and cross-order validation"
      contains: "_inherit = 'sale.order.line'"
    - path: "addons/spora_segment/models/sale_order_segment.py"
      provides: "Extended segment model with line_ids, currency_id, subtotal, total, parent_same_order constraint"
      contains: "_compute_subtotal"
    - path: "addons/spora_segment/views/sale_order_views.xml"
      provides: "Inherited sale order form with smart button and segment tab"
      contains: "sale_order_view_form_inherit_segment"
  key_links:
    - from: "addons/spora_segment/models/sale_order.py"
      to: "sale.order.segment via segment_ids One2many"
      via: "One2many('sale.order.segment', 'order_id')"
      pattern: "segment_ids.*One2many"
    - from: "addons/spora_segment/models/sale_order_line.py"
      to: "sale.order.segment via segment_id Many2one"
      via: "Many2one with domain and constraint"
      pattern: "segment_id.*Many2one"
    - from: "addons/spora_segment/models/sale_order_segment.py"
      to: "sale.order.line via line_ids One2many"
      via: "One2many('sale.order.line', 'segment_id')"
      pattern: "line_ids.*One2many"
    - from: "addons/spora_segment/views/sale_order_views.xml"
      to: "sale.view_order_form via inherit_id"
      via: "xpath injection into notebook and button_box"
      pattern: "inherit_id.*sale.view_order_form"
---

<objective>
Integrate sale.order.segment with sale.order and sale.order.line models, creating bidirectional relationships, computed subtotals/totals, smart button navigation, and the segment management tab in the sale order form.

Purpose: This is the core Phase 2 deliverable -- connecting the standalone segment model from Phase 1 to Odoo's native sale order workflow so users can organize order lines into hierarchical segments with automatic financial calculations.

Output: Three new/modified Python models, two new/modified XML view files, updated module manifest -- all wired together for a complete sale order integration.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-model-structure/01-01-SUMMARY.md
@.planning/phases/02-sale-order-integration/02-RESEARCH.md
@addons/spora_segment/models/sale_order_segment.py
@addons/spora_segment/views/sale_order_segment_views.xml
@addons/spora_segment/__manifest__.py
@addons/spora_segment/models/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model extensions and modify segment model</name>
  <files>
    addons/spora_segment/models/sale_order.py
    addons/spora_segment/models/sale_order_line.py
    addons/spora_segment/models/sale_order_segment.py
    addons/spora_segment/models/__init__.py
    addons/spora_segment/__manifest__.py
  </files>
  <action>
    **1. Create `addons/spora_segment/models/sale_order.py`:**

    Extend `sale.order` via `_inherit = 'sale.order'`. Add:

    - `segment_ids = fields.One2many('sale.order.segment', 'order_id', string='Segments')` -- links order to its segments.
    - `segment_count = fields.Integer(compute='_compute_segment_count', string='Segment Count')` -- for smart button badge. Use `len(order.segment_ids)` in compute. Do NOT use `store=True` (count changes dynamically with segment operations).
    - `action_view_segments(self)` method -- returns `ir.actions.act_window` dict with `res_model='sale.order.segment'`, `view_mode='list,form'`, `domain=[('order_id', '=', self.id)]`, `context={'default_order_id': self.id}`. Use `self.ensure_one()`.

    **IMPORTANT:** Use `view_mode='list,form'` NOT `'tree,form'` (Odoo 18 syntax change discovered in Phase 1).

    **2. Create `addons/spora_segment/models/sale_order_line.py`:**

    Extend `sale.order.line` via `_inherit = 'sale.order.line'`. Add:

    - `segment_id = fields.Many2one('sale.order.segment', string='Segment', domain="[('order_id', '=', order_id)]", index=True)` -- assigns line to segment. Domain filters dropdown to segments from same order.
    - `@api.constrains('segment_id', 'order_id')` method `_check_segment_order` -- validates `segment_id.order_id == order_id` when `segment_id` is set. Raises `ValidationError` if mismatch. This is the data integrity backup for the UI domain filter.

    **3. Modify `addons/spora_segment/models/sale_order_segment.py`:**

    Add these fields and methods to the existing model (do NOT create a separate _inherit file -- modify the _name class directly since it's our own model):

    - Change `order_id` from `required=False` to `required=True`. Update help text to remove "Phase 2" reference.
    - Add `currency_id = fields.Many2one(related='order_id.currency_id', store=True, readonly=True)` -- needed by Monetary fields.
    - Add `line_ids = fields.One2many('sale.order.line', 'segment_id', string='Order Lines')` -- inverse of segment_id on sale.order.line.
    - Add `subtotal = fields.Monetary(string='Subtotal', compute='_compute_subtotal', store=True, currency_field='currency_id', help='Sum of order lines directly assigned to this segment.')`.
    - Add `total = fields.Monetary(string='Total', compute='_compute_total', store=True, currency_field='currency_id', help='Subtotal plus total of all child segments (recursive).')`.
    - Add `@api.depends('line_ids.price_subtotal')` on `_compute_subtotal` -- uses `sum(segment.line_ids.mapped('price_subtotal'))`.
    - Add `@api.depends('subtotal', 'child_ids.total')` on `_compute_total` -- uses `segment.subtotal + sum(segment.child_ids.mapped('total'))`.
    - Add `@api.constrains('parent_id', 'order_id')` method `_check_parent_same_order` -- validates that `parent_id.order_id == self.order_id` when parent_id is set. Raises `ValidationError` if mismatch. This prevents cross-order hierarchy.
    - Add domain filter on `parent_id` field definition: `domain="[('order_id', '=', order_id)]"` to restrict parent dropdown to same-order segments in the UI.

    **IMPORTANT dependency note:** `@api.depends('line_ids.price_subtotal')` uses dotted path to track price changes, not just line add/remove. `@api.depends('child_ids.total')` creates recursive cascade for hierarchy total propagation.

    **4. Update `addons/spora_segment/models/__init__.py`:**

    Add imports: `from . import sale_order` and `from . import sale_order_line` (in addition to existing `sale_order_segment` import).

    **5. Update `addons/spora_segment/__manifest__.py`:**

    Add `'views/sale_order_views.xml'` to the `data` list, after the existing entries.

    **What to avoid:**
    - Do NOT use `_inherit = 'sale.order.segment'` in a separate file for segment modifications. Modify the existing `_name = 'sale.order.segment'` class directly since it's our module's own model.
    - Do NOT forget `currency_field='currency_id'` on Monetary fields. Without it, monetary values display without currency symbol.
    - Do NOT use `sum()` directly on recordsets. Always use `sum(records.mapped('field_name'))`.
  </action>
  <verify>
    Run: `python3 -c "import ast; ast.parse(open('addons/spora_segment/models/sale_order.py').read()); ast.parse(open('addons/spora_segment/models/sale_order_line.py').read()); ast.parse(open('addons/spora_segment/models/sale_order_segment.py').read()); print('All Python files parse OK')"` from the project root.

    Verify `__init__.py` imports all three model files.
    Verify `__manifest__.py` lists both XML view files.
  </verify>
  <done>
    - `sale_order.py` extends sale.order with segment_ids, segment_count, action_view_segments
    - `sale_order_line.py` extends sale.order.line with segment_id + cross-order constraint
    - `sale_order_segment.py` has order_id (required), currency_id, line_ids, subtotal, total, parent_same_order constraint, parent_id domain
    - `__init__.py` imports all three model files
    - `__manifest__.py` lists sale_order_views.xml
  </done>
</task>

<task type="auto">
  <name>Task 2: Create and update XML views for sale order integration</name>
  <files>
    addons/spora_segment/views/sale_order_views.xml
    addons/spora_segment/views/sale_order_segment_views.xml
  </files>
  <action>
    **1. Create `addons/spora_segment/views/sale_order_views.xml`:**

    This file contains two view inheritance records:

    **A. Sale order form inheritance (`sale_order_view_form_inherit_segment`):**

    Inherits `sale.view_order_form` via `inherit_id ref="sale.view_order_form"`.

    Smart button (xpath into `//div[@name='button_box']` position="inside"):
    ```xml
    <button name="action_view_segments"
            type="object"
            class="oe_stat_button"
            icon="fa-sitemap"
            invisible="segment_count == 0">
        <field name="segment_count" widget="statinfo" string="Segments"/>
    </button>
    ```

    Segment tab (xpath into `//notebook` position="inside"):
    ```xml
    <page string="Segments" name="segments">
        <field name="segment_ids" context="{'default_order_id': active_id}">
            <list>
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="parent_id" domain="[('order_id', '=', parent.id)]"/>
                <field name="level" readonly="1"/>
                <field name="subtotal" sum="Subtotal"/>
                <field name="total" sum="Total"/>
            </list>
        </field>
    </page>
    ```

    **CRITICAL Odoo 18 note:** Use `<list>` not `<tree>` for inline view (discovered in Phase 1: Odoo 18 changed view schema). Use `invisible="expression"` not `attrs={'invisible': [...]}`.

    **Context propagation:** `context="{'default_order_id': active_id}"` ensures new segments get order_id auto-populated.

    **Domain on parent_id inline:** `domain="[('order_id', '=', parent.id)]"` restricts parent_id dropdown to segments from the same sale order when editing inline. `parent.id` refers to the sale order record in Odoo's inline view context.

    **B. Sale order line tree/form inheritance:**

    Inherit the sale order line tree view displayed inside the sale order form to add the segment_id column. The sale order form uses an inline tree for order lines. We need to add segment_id there.

    Create a record inheriting `sale.view_order_form` (same parent view) with a separate xpath targeting the order line tree. Use `<xpath expr="//field[@name='order_line']//list//field[@name='product_id']" position="after">` to add `<field name="segment_id" optional="hide"/>` after product_id in the order line inline list.

    The `optional="hide"` attribute makes the column hidden by default but available via the column toggle menu. This avoids cluttering the default order line view.

    **2. Update `addons/spora_segment/views/sale_order_segment_views.xml`:**

    Modify the existing segment list view to include subtotal and total columns:
    - Add `<field name="subtotal" sum="Subtotal"/>` after `child_count`
    - Add `<field name="total" sum="Total"/>` after subtotal
    - Add `<field name="order_id"/>` after parent_id

    Modify the existing segment form view:
    - Add `<field name="currency_id" invisible="1"/>` (hidden, needed for Monetary rendering)
    - Add an "Order Lines" page to the notebook showing `line_ids` in an inline list with columns: product_id, product_uom_qty, price_unit, price_subtotal
    - Add `<field name="subtotal" readonly="1"/>` and `<field name="total" readonly="1"/>` to the second group (alongside sequence and level)
    - Update the parent_id field to include domain: `domain="[('order_id', '=', order_id)]"`

    **What to avoid:**
    - Do NOT create a completely new sale order form view. Always use `inherit_id` + xpath to inject into existing views.
    - Do NOT use `<tree>` tag -- Odoo 18 requires `<list>`.
    - Do NOT place the segment_id column before product_id in order lines (product is the primary identifier).
  </action>
  <verify>
    Run: `xmllint --noout addons/spora_segment/views/sale_order_views.xml && echo "sale_order_views.xml is valid XML"` (if xmllint available).

    Otherwise validate by visual inspection: well-formed XML with matching tags, correct xpath expressions, proper Odoo record structure.

    Then run module update in Docker to verify views load without errors:
    ```bash
    docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init 2>&1 | tail -20
    ```

    Module should update successfully without XML validation errors.
  </verify>
  <done>
    - `sale_order_views.xml` inherits sale order form with smart button and segment tab
    - Segment tab shows inline list with sequence handle, name, parent_id, level, subtotal, total
    - Order line inline list has optional segment_id column
    - `sale_order_segment_views.xml` updated with subtotal, total, order_id columns and order line tab in form
    - Module installs/updates without errors in Docker
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Module update:** `docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init` completes without errors
2. **Model check:** All three models load correctly (sale.order has segment_ids, sale.order.line has segment_id, sale.order.segment has line_ids/subtotal/total)
3. **View check:** Sale order form shows Segments tab and smart button in Odoo web interface
4. **Python syntax:** All .py files parse without errors
5. **XML syntax:** All .xml files are well-formed
</verification>

<success_criteria>
- Module updates cleanly in Odoo 18 Docker (no migration or validation errors)
- sale.order model has segment_ids (One2many) and segment_count (computed Integer)
- sale.order.line model has segment_id (Many2one) with domain and constraint
- sale.order.segment model has line_ids, currency_id, subtotal, total fields
- sale.order.segment has parent_same_order constraint
- Sale order form view has smart button and Segments tab
- Segment inline list shows name, parent, level, subtotal, total
- order_id defaults correctly when creating segment from sale order form
</success_criteria>

<output>
After completion, create `.planning/phases/02-sale-order-integration/02-01-SUMMARY.md`
</output>
