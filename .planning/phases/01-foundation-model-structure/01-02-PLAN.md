---
phase: 01-foundation-model-structure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - addons/spora_segment/tests/__init__.py
  - addons/spora_segment/tests/test_sale_order_segment.py
autonomous: true

must_haves:
  truths:
    - "Root segment gets level=1 automatically"
    - "Child segment gets level=parent.level+1 automatically"
    - "4-level deep segment (level=4) can be created successfully"
    - "5th level segment is blocked with ValidationError"
    - "Circular reference (A->B->A) is blocked with ValidationError"
    - "Reparenting a subtree that would exceed depth limit is blocked with ValidationError"
    - "Self-reference (segment as its own parent) is blocked with ValidationError"
    - "Deleting parent cascades to children"
    - "Segments order by sequence field"
    - "Segment can exist without parent (root segment)"
    - "Segment can exist without children (leaf segment)"
    - "Module installs successfully in Docker Odoo 18"
  artifacts:
    - path: "addons/spora_segment/tests/__init__.py"
      provides: "Test module import"
      contains: "from . import test_sale_order_segment"
    - path: "addons/spora_segment/tests/test_sale_order_segment.py"
      provides: "Comprehensive hierarchy tests"
      contains: "class TestSaleOrderSegment"
  key_links:
    - from: "addons/spora_segment/tests/test_sale_order_segment.py"
      to: "sale.order.segment"
      via: "self.env['sale.order.segment']"
      pattern: "env\\['sale.order.segment'\\]"
    - from: "addons/spora_segment/tests/test_sale_order_segment.py"
      to: "odoo.exceptions.ValidationError"
      via: "import and assertRaises"
      pattern: "assertRaises.*ValidationError"
---

<objective>
Write comprehensive tests for the sale.order.segment model covering all HIER requirements, then verify the module installs and tests pass in the Docker Odoo 18 environment.

Purpose: Validate that all hierarchy logic works correctly -- level computation, circular reference prevention, depth limit enforcement, cascade deletion, and sibling ordering. Tests also serve as living documentation of expected behavior for future phases.

Output: Test file with 10+ test methods covering all HIER-01 through HIER-10 requirements, verified passing in Docker.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-model-structure/01-RESEARCH.md
@.planning/phases/01-foundation-model-structure/01-01-SUMMARY.md
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write comprehensive hierarchy tests</name>
  <files>
    addons/spora_segment/tests/__init__.py
    addons/spora_segment/tests/test_sale_order_segment.py
  </files>
  <action>
    Create tests directory and test file following Odoo 18 testing patterns from the research.

    1. Create `addons/spora_segment/tests/__init__.py`:
       - Single line: `from . import test_sale_order_segment`

    2. Create `addons/spora_segment/tests/test_sale_order_segment.py`:
       Use TransactionCase base class with @tagged('at_install').

       ```python
       from odoo.tests import TransactionCase, tagged
       from odoo.exceptions import ValidationError

       @tagged('at_install')
       class TestSaleOrderSegment(TransactionCase):

           @classmethod
           def setUpClass(cls):
               super().setUpClass()
               cls.Segment = cls.env['sale.order.segment']
       ```

       Required test methods (map to HIER requirements):

       HIER-01 (parent_id field):
       - test_create_segment_with_parent: Create root, create child with parent_id, assert child.parent_id == root

       HIER-02 (child_ids inverse):
       - test_child_ids_inverse: Create root, create 2 children, assert root.child_ids has length 2

       HIER-03 (_parent_store / parent_path):
       - test_parent_path_populated: Create root + child, assert both have non-empty parent_path
       - test_parent_path_format: Root parent_path should contain root.id, child parent_path should contain both IDs

       HIER-04 (computed level):
       - test_level_root: Root segment has level=1
       - test_level_child: Direct child has level=2
       - test_level_grandchild: Grandchild has level=3
       - test_level_great_grandchild: Great-grandchild has level=4
       - test_level_updates_on_reparent: Move a child to different parent, level recalculates

       HIER-05 (circular reference prevention):
       - test_circular_reference_direct: Set root.parent_id = child.id raises ValidationError
         NOTE: Use _has_cycle() in model (Odoo 18), not deprecated _check_recursion()
       - test_circular_reference_indirect: A->B->C, set A.parent_id = C.id raises ValidationError
       - test_self_parent_blocked: segment.write({'parent_id': segment.id}) raises ValidationError
         (special case of circular reference)

       HIER-06 (max 4 levels):
       - test_depth_limit_4_allowed: Create 4 levels deep, no error
       - test_depth_limit_5_blocked: Create 5 levels deep raises ValidationError
       - test_depth_limit_reparent_blocked: Moving a level-3 subtree under a level-2 parent (would create level 5) raises ValidationError
       - test_reparent_subtree_exceeds_depth: **CRITICAL** Create A(L1)->B(L2)->C(L3)->D(L4) and X(L1)->Y(L2)->Z(L3).
         Move B under Z. Should raise ValidationError because B becomes L4, C becomes L5, D becomes L6.
         This validates that constraint checks entire subtree, not just the segment being moved.

       HIER-07 (sequence field):
       - test_sequence_default: New segment has sequence=10 by default
       - test_ordering_by_sequence: Create segments with different sequences, verify model._order respects sequence

       HIER-08/09/10 (segments can have products only, sub-segments only, or both):
       - test_segment_without_children: Segment without child_ids is valid (leaf/product-only segment)
       - test_segment_with_children_no_restriction: Segment with child_ids is valid (sub-segments only or both)
       - Note: Product assignment is Phase 2 (sale.order.line.segment_id), so HIER-08/10 product side cannot be tested here. Test that model design does NOT block having children (no constraint preventing coexistence).

       Additional edge cases (required):
       - test_cascade_delete: Delete parent, children are deleted too
       - test_child_count_computed: Verify child_count matches len(child_ids)
       - test_active_field_default: New segment has active=True

       Additional edge cases (optional but recommended):
       - test_parent_path_updates_on_reparent: Move segment to different parent, verify parent_path updates
       - test_level_updates_cascade_on_reparent: Move B from A(L1) to X(L2), verify B and its children levels update
       - test_batch_create_segments: Create multiple segments in single create() call with list of dicts

    Each test should be focused (one assert concept per test), well-named, and have a docstring explaining what it validates.

    IMPORTANT: The constraint uses _has_cycle() (Odoo 18 standard), NOT _check_recursion() (deprecated).
  </action>
  <verify>
    1. File exists at addons/spora_segment/tests/test_sale_order_segment.py
    2. Python syntax check passes
    3. Test file contains at least 17 test methods (including critical reparenting subtree test)
    4. All test methods start with test_
    5. Class uses @tagged('at_install') decorator
    6. setUpClass creates Segment reference via cls.env['sale.order.segment']
    7. Test file imports ValidationError from odoo.exceptions
    8. Tests use assertRaises(ValidationError) for constraint validation
  </verify>
  <done>
    Test file with 17+ test methods covering HIER-01 through HIER-10 requirements: parent_id/child_ids relationships, parent_path population, level computation at all 4 depths, circular reference blocking (including self-reference), depth limit enforcement (including critical reparenting subtree test), sequence ordering, cascade deletion, and segment flexibility (leaf/branch/both). Uses Odoo 18 _has_cycle() method for circular reference detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install module and run tests in Docker</name>
  <files>
    addons/spora_segment/tests/test_sale_order_segment.py
  </files>
  <action>
    Verify the complete module works in the Docker Odoo 18 environment.

    Step 1: Ensure Docker containers are running:
    ```bash
    docker compose up -d
    ```
    Wait for containers to be healthy (odoo + db).

    Step 2: Create/reset test database and install the module:
    ```bash
    docker compose exec odoo odoo -d spora_test -i spora_segment --stop-after-init --no-http
    ```
    This installs the module on a test database. Watch for:
    - No Python import errors
    - No XML parsing errors
    - No security file errors
    - Successful installation message

    Step 3: Run the test suite:
    ```bash
    docker compose exec odoo odoo --test-tags /spora_segment -d spora_test --stop-after-init --no-http --log-level=test
    ```
    All tests should pass.

    Step 4: If tests fail, fix the issues in the test file or model file. Common issues:
    - Constraint timing (level not yet computed when constraint fires -- use parent chain walking)
    - parent_path format assumptions (format is "id1/id2/id3/")
    - Missing env commit between create and constraint check

    Step 5: If module installation fails, check:
    - XML syntax (especially Odoo 17+ attribute syntax)
    - CSV header format in ir.model.access.csv
    - Import chain (__init__.py files)
    - Manifest data list order
  </action>
  <verify>
    1. `docker compose exec odoo odoo -d spora_test -i spora_segment --stop-after-init --no-http` exits with code 0
    2. `docker compose exec odoo odoo --test-tags /spora_segment -d spora_test --stop-after-init --no-http --log-level=test` exits with code 0
    3. Test output shows all tests passed, no failures or errors
    4. No WARNING or ERROR lines related to spora_segment in the output
  </verify>
  <done>
    Module installs cleanly on Odoo 18 Docker. All hierarchy tests pass: level computation, circular reference prevention, depth limit enforcement, cascade deletion, sequence ordering, parent_path population. The sale.order.segment model is production-ready for Phase 2 integration.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Tests directory exists with __init__.py and test file
2. Module installs without errors on Odoo 18 Docker
3. All 17+ tests pass with zero failures
4. Test coverage maps to all 10 HIER requirements:
   - HIER-01: parent_id relationship tested
   - HIER-02: child_ids inverse tested
   - HIER-03: parent_path populated tested
   - HIER-04: level computation at all depths tested (including reparenting)
   - HIER-05: circular reference prevention tested (direct/indirect/self-reference)
   - HIER-06: 4-level limit enforced tested (including critical subtree reparenting case)
   - HIER-07: sequence ordering tested
   - HIER-08/09/10: segment flexibility tested (no blocking constraints)
5. Tests use _has_cycle() (Odoo 18) not deprecated _check_recursion()
</verification>

<success_criteria>
- 17+ test methods in test_sale_order_segment.py (including critical subtree reparenting test)
- Module installs on Odoo 18 Docker without errors
- All tests pass with `--test-tags /spora_segment`
- Every HIER requirement has at least one corresponding test
- Tests validate both simple cases and edge cases (self-reference, subtree depth)
- Uses Odoo 18 API (_has_cycle() not _check_recursion())
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-model-structure/01-02-SUMMARY.md`
</output>
