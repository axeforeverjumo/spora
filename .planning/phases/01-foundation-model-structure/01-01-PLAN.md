---
phase: 01-foundation-model-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/spora_segment/__init__.py
  - addons/spora_segment/__manifest__.py
  - addons/spora_segment/models/__init__.py
  - addons/spora_segment/models/sale_order_segment.py
  - addons/spora_segment/security/ir.model.access.csv
  - addons/spora_segment/views/sale_order_segment_views.xml
autonomous: true

must_haves:
  truths:
    - "sale.order.segment model exists with parent_id, child_ids, parent_path, level, sequence fields"
    - "Level is computed automatically based on parent depth (root=1, child=2, etc.)"
    - "Circular references are blocked with ValidationError"
    - "Segments deeper than 4 levels are blocked with ValidationError"
    - "Sibling ordering via sequence field is supported"
    - "Module has proper security rules for Sales User (CRUD minus delete) and Sales Manager (full CRUD)"
    - "Tree, form, and search views are defined and loadable"
  artifacts:
    - path: "addons/spora_segment/models/sale_order_segment.py"
      provides: "sale.order.segment model with hierarchy"
      contains: "_parent_store = True"
    - path: "addons/spora_segment/__manifest__.py"
      provides: "Module metadata and dependency declaration"
      contains: "'depends': ['sale']"
    - path: "addons/spora_segment/security/ir.model.access.csv"
      provides: "Access rights for Sales User and Sales Manager"
      contains: "model_sale_order_segment"
    - path: "addons/spora_segment/views/sale_order_segment_views.xml"
      provides: "Tree, form, and search views for segment model"
      contains: "sale.order.segment"
  key_links:
    - from: "addons/spora_segment/__manifest__.py"
      to: "security/ir.model.access.csv"
      via: "data list in manifest"
      pattern: "security/ir.model.access.csv"
    - from: "addons/spora_segment/__manifest__.py"
      to: "views/sale_order_segment_views.xml"
      via: "data list in manifest"
      pattern: "views/sale_order_segment_views.xml"
    - from: "addons/spora_segment/__init__.py"
      to: "models/"
      via: "Python import"
      pattern: "from . import models"
    - from: "addons/spora_segment/models/__init__.py"
      to: "models/sale_order_segment.py"
      via: "Python import"
      pattern: "from . import sale_order_segment"
---

<objective>
Create the complete spora_segment Odoo 18 module with the sale.order.segment hierarchical model, security access rules, and XML views.

Purpose: This is the foundation for the entire project. The segment model with its hierarchy logic (parent_id, _parent_store, computed level, circular reference prevention, 4-level depth limit) is the core data structure that all subsequent phases build upon.

Output: A fully structured Odoo 18 module in addons/spora_segment/ with model, security, and views ready for installation.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-model-structure/01-RESEARCH.md
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create module scaffold and segment model with hierarchy logic</name>
  <files>
    addons/spora_segment/__init__.py
    addons/spora_segment/__manifest__.py
    addons/spora_segment/models/__init__.py
    addons/spora_segment/models/sale_order_segment.py
    addons/spora_segment/security/ir.model.access.csv
  </files>
  <action>
    Create the Odoo 18 module structure for spora_segment following the research patterns.

    1. Create `addons/spora_segment/__init__.py`:
       - Single line: `from . import models`

    2. Create `addons/spora_segment/models/__init__.py`:
       - Single line: `from . import sale_order_segment`

    3. Create `addons/spora_segment/__manifest__.py`:
       - name: 'Spora - Hierarchical Budget Segments'
       - version: '18.0.1.0.0'
       - category: 'Sales'
       - depends: ['sale']
       - data: ['security/ir.model.access.csv', 'views/sale_order_segment_views.xml']
       - installable: True, application: False, license: 'LGPL-3'

    4. Create `addons/spora_segment/models/sale_order_segment.py`:
       Follow the product.category pattern from the research exactly:

       - Class: SaleOrderSegment
       - _name = 'sale.order.segment'
       - _description = 'Sale Order Segment'
       - _parent_name = 'parent_id'
       - _parent_store = True
       - _order = 'sequence, id'

       Core fields:
       - name: Char, required=True, translate=True
       - sequence: Integer, default=10
       - active: Boolean, default=True

       Hierarchy fields:
       - parent_id: Many2one('sale.order.segment', index=True, ondelete='cascade')
       - parent_path: Char(index=True, unaccent=False) -- MUST be declared explicitly even with _parent_store=True
       - child_ids: One2many('sale.order.segment', 'parent_id')

       Future integration field (include now to avoid migration later):
       - order_id: Many2one('sale.order', string='Sale Order', index=True, ondelete='cascade')
         Make it optional (required=False) -- Phase 2 will enforce via view context.

       Computed fields:
       - level: Integer, compute='_compute_level', store=True, recursive=True
         Use @api.depends('parent_id', 'parent_id.level') -- NOT parent_path (timing issue with constraints)
         Root segments get level=1, children get parent.level + 1
       - child_count: Integer, compute='_compute_child_count' (non-stored, just len(child_ids))

       Constraints:
       - @api.constrains('parent_id') method _check_hierarchy():
         Step 1: Call self._check_recursion() -- raises ValidationError if circular reference detected
         Step 2: For each segment, walk parent_id chain counting depth. If depth > 4, raise ValidationError.
         Use MAX_HIERARCHY_DEPTH = 4 constant at module level.
         IMPORTANT: Walk parent chain in constraint, do NOT rely on computed level field (timing issue).

       Display name:
       - _rec_name = 'name' (default, but explicit for clarity)

    5. Create `addons/spora_segment/security/ir.model.access.csv`:
       ```
       id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
       access_sale_order_segment_user,sale.order.segment user,model_sale_order_segment,sales_team.group_sale_salesman,1,1,1,0
       access_sale_order_segment_manager,sale.order.segment manager,model_sale_order_segment,sales_team.group_sale_manager,1,1,1,1
       ```

    IMPORTANT anti-patterns to avoid:
    - Do NOT use @api.depends('parent_path') for level computation (parent_path may not be updated when constraint fires)
    - Do NOT forget parent_path field declaration (even with _parent_store=True)
    - Do NOT use deprecated attrs={} syntax in any XML -- use inline expressions (Odoo 17+)
    - Do NOT use @api.one or @api.multi (removed in Odoo 13+)
    - Do NOT use name_get() (deprecated in Odoo 17+)
  </action>
  <verify>
    1. All files exist: __init__.py (x2), __manifest__.py, sale_order_segment.py, ir.model.access.csv
    2. Python syntax check: `python3 -c "import ast; ast.parse(open('addons/spora_segment/models/sale_order_segment.py').read())"` passes
    3. Model file contains: _parent_store = True, parent_path field, _check_recursion(), MAX_HIERARCHY_DEPTH
    4. Security CSV has exactly 2 data rows (user + manager)
    5. Manifest data list has security BEFORE views (Odoo loads in order, security must come first)
  </verify>
  <done>
    Module scaffold complete with: model defining parent_id/child_ids/parent_path/level/sequence/order_id fields, circular reference constraint, 4-level depth constraint, and access rights for Sales User and Sales Manager.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create segment views (tree, form, search) and menu action</name>
  <files>
    addons/spora_segment/views/sale_order_segment_views.xml
  </files>
  <action>
    Create the XML views file following Odoo 18 patterns from the research.

    Create `addons/spora_segment/views/sale_order_segment_views.xml`:

    1. Tree View (sale_order_segment_view_tree):
       - sequence field with handle widget (for drag-drop reordering)
       - name field
       - parent_id field
       - level field
       - child_count field

    2. Form View (sale_order_segment_view_form):
       - Button box with stat button for sub-segments:
         - button name="action_view_children" type="object" class="oe_stat_button" icon="fa-sitemap"
         - invisible="child_count == 0" (Odoo 17+ inline expression, NOT attrs={})
         - Shows child_count with statinfo widget
       - Group 1: name, parent_id, order_id
       - Group 2: sequence, level (level should be readonly since it's computed)
       - Notebook page "Sub-segments": child_ids as inline tree with sequence handle, name, level columns

    3. Search View (sale_order_segment_view_search):
       - Field filters: name, parent_id
       - Filter "Root Segments": domain [('parent_id', '=', False)]
       - Group By: parent_id, level

    4. Action (sale_order_segment_action):
       - res_model: sale.order.segment
       - view_mode: tree,form
       - search_view_id referencing the search view
       - context with search_default_root: 1

    5. Add action_view_children method to model (needed for stat button):
       Actually, this method needs to be in the Python model file. Add it to sale_order_segment.py:
       ```python
       def action_view_children(self):
           self.ensure_one()
           return {
               'type': 'ir.actions.act_window',
               'name': 'Sub-segments',
               'res_model': 'sale.order.segment',
               'view_mode': 'tree,form',
               'domain': [('parent_id', '=', self.id)],
               'context': {'default_parent_id': self.id},
           }
       ```

    IMPORTANT: Use Odoo 17+ syntax for all XML attributes:
    - Use invisible="expression" NOT attrs="{'invisible': [...]}"
    - Use readonly="expression" NOT attrs="{'readonly': [...]}"
    - Wrap entire file in <odoo> root element
  </action>
  <verify>
    1. File exists at addons/spora_segment/views/sale_order_segment_views.xml
    2. XML is well-formed: `python3 -c "import xml.etree.ElementTree as ET; ET.parse('addons/spora_segment/views/sale_order_segment_views.xml')"` passes
    3. Contains 4 ir.ui.view records (tree, form, search) + 1 action record
    4. No deprecated attrs={} syntax used anywhere
    5. action_view_children method exists in sale_order_segment.py
  </verify>
  <done>
    Views XML file contains tree view with handle widget, form view with stat button and child_ids notebook page, search view with root filter and group-by options, and window action. Model has action_view_children method for stat button navigation.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All module files exist in addons/spora_segment/ with correct directory structure
2. Python files parse without syntax errors
3. XML files parse without errors
4. Manifest references all data files in correct order (security before views)
5. Model has all required fields: name, sequence, active, parent_id, parent_path, child_ids, level, child_count, order_id
6. Model has _parent_store = True and parent_path explicitly declared
7. Constraint method validates both circular references and depth limit
8. Security CSV defines access for Sales User and Sales Manager
</verification>

<success_criteria>
- Complete Odoo 18 module structure at addons/spora_segment/
- sale.order.segment model with hierarchy fields, computed level, and validation constraints
- Security rules for two user groups
- Tree, form, and search views with Odoo 17+ syntax
- All files syntactically valid (Python + XML)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-model-structure/01-01-SUMMARY.md`
</output>
