---
phase: 03-project-extension-security
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - addons/spora_segment/tests/test_project_task_segment.py
  - addons/spora_segment/tests/__init__.py
autonomous: true

must_haves:
  truths:
    - "Test confirms segment_id field exists on project.task model"
    - "Test confirms segment_id visible when project has sale_order_id"
    - "Test confirms cross-order segment assignment triggers onchange warning (returns warning dict, task can be saved)"
    - "Test confirms segment deletion blocked when tasks exist"
    - "Test confirms project sale_order_id change blocked when segment tasks exist"
    - "Test confirms segment display_name shows 'Order / Segment Name'"
    - "Test confirms Sales User can create segments on own orders"
    - "Test confirms Sales User cannot write segments on other users' orders"
    - "All Phase 1 and Phase 2 tests still pass (no regressions)"
  artifacts:
    - path: "addons/spora_segment/tests/test_project_task_segment.py"
      provides: "Comprehensive test suite for PROJ-01, PROJ-02, PROJ-03, SEC-01 through SEC-04"
      contains: "class TestProjectTaskSegment"
  key_links:
    - from: "addons/spora_segment/tests/test_project_task_segment.py"
      to: "project.task"
      via: "self.env['project.task'].create() with segment_id"
      pattern: "project\\.task.*create"
    - from: "addons/spora_segment/tests/test_project_task_segment.py"
      to: "sale.order.segment"
      via: "segment creation and deletion tests"
      pattern: "sale\\.order\\.segment"
---

<objective>
Write and execute comprehensive tests covering all PROJ and SEC requirements: segment_id field on project.task, cross-order validation, deletion protection, sale_order_id change constraint, display_name format, and security record rules (Sales User vs Sales Manager). Verify all tests pass in Odoo 18 Docker with zero regressions.

Purpose: Validate Phase 3 implementation and provide regression protection for Phase 4's automated task creation.
Output: Passing test suite covering 7 requirements (PROJ-01/02/03, SEC-01/02/03/04) with Docker verification.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-project-extension-security/03-CONTEXT.md
@.planning/phases/03-project-extension-security/03-RESEARCH.md
@.planning/phases/03-project-extension-security/03-01-SUMMARY.md

Key existing test files to reference for patterns:
@addons/spora_segment/tests/test_sale_order_segment.py
@addons/spora_segment/tests/test_sale_order_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write comprehensive tests for project task segment integration and security</name>
  <files>
    addons/spora_segment/tests/test_project_task_segment.py
    addons/spora_segment/tests/__init__.py
  </files>
  <action>
    **1. Create `addons/spora_segment/tests/test_project_task_segment.py`:**

    Use `TransactionCase` with `@tagged('post_install', '-at_install')` (same as Phase 2 integration tests — requires sale and project modules installed).

    **setUpClass data:**
    - Create two users: `user_salesman` (group_sale_salesman) and `user_manager` (group_sale_manager)
    - Create a second salesman: `user_salesman2` for cross-user security tests
    - Create a partner (res.partner)
    - Create a product with fixed price
    - Create two sale orders: `order1` (assigned to user_salesman) and `order2` (assigned to user_salesman2)
    - Create segments in each order (root + child for hierarchy tests)
    - Create a project linked to order1: `project1` with `sale_order_id=order1.id`
    - Create a manual project without sale_order_id: `project_manual`

    **Test methods — PROJ requirements:**

    `test_segment_id_field_exists` (PROJ-01):
    - Assert 'segment_id' in self.env['project.task']._fields

    `test_task_with_segment_valid` (PROJ-01):
    - Create task in project1 with segment_id from order1 → success, no error

    `test_task_without_segment` (PROJ-01):
    - Create task in project1 without segment_id → success (field is optional)

    `test_task_manual_project_no_segment` (PROJ-01):
    - Create task in project_manual without segment_id → success

    `test_cross_order_segment_onchange_warning` (PROJ-03):
    - Create task via `self.env['project.task'].new({...})` in project1 with segment from order2
    - Call `task._onchange_segment_order_warning()`
    - Assert result is not None, contains 'warning' key with 'title' and 'message'
    - This verifies the onchange returns a warning dict (modal popup), NOT a ValidationError

    `test_cross_order_segment_can_save` (PROJ-03):
    - Create task via `self.env['project.task'].create({...})` in project1 with segment from order2
    - Assert task.id is truthy (task was saved successfully despite cross-order segment)
    - Assert task.segment_id.id equals the cross-order segment id
    - This confirms the onchange is advisory: user can acknowledge warning and proceed with save

    `test_same_order_segment_no_warning` (PROJ-03):
    - Create task via `self.env['project.task'].new({...})` in project1 with segment from order1 (correct order)
    - Call `task._onchange_segment_order_warning()`
    - Assert result is None (no warning for correctly matched segment)

    `test_segment_on_project_without_sale_order` (PROJ-03):
    - Create task via `self.env['project.task'].new({...})` in project_manual with segment_id
    - Call `task._onchange_segment_order_warning()`
    - Assert result is None (no warning when project has no sale_order_id — onchange only checks when both segment_id AND project.sale_order_id exist)

    **Test methods — display_name:**

    `test_segment_display_name_format`:
    - Assert segment.display_name == 'SO001 / Segment Name' (checks the "Nombre + orden" format)

    `test_segment_display_name_without_order`:
    - Edge case: segment without order (if possible) shows just the name

    **Test methods — deletion protection:**

    `test_segment_delete_blocked_with_tasks`:
    - Create task linked to segment → try to unlink segment → assertRaises(UserError)

    `test_segment_delete_allowed_without_tasks`:
    - Create segment with no tasks → unlink succeeds

    **Test methods — project sale_order_id change:**

    `test_project_sale_order_change_blocked_with_segment_tasks`:
    - Create task in project1 with segment_id → try to change project1.sale_order_id → assertRaises(ValidationError)

    `test_project_sale_order_change_allowed_without_segment_tasks`:
    - Create task in project1 WITHOUT segment_id → changing sale_order_id should be allowed (no segment tasks)

    **Test methods — SEC requirements:**

    `test_salesman_can_create_segment_own_order` (SEC-02):
    - Using user_salesman context (`with_user(user_salesman)`), create segment on order1 → success

    `test_salesman_cannot_write_segment_other_order` (SEC-04):
    - Using user_salesman context, try to write (modify name) on segment in order2 (owned by salesman2) → assertRaises(AccessError)

    `test_salesman_can_read_all_segments` (SEC-02/SEC-04):
    - Using user_salesman context, search for segments on order2 → should return results (read access)

    `test_manager_full_crud_all_segments` (SEC-03):
    - Using user_manager context, read, write, create, and unlink segments (ensure unlink is on segment without tasks) → all succeed

    Import: `from odoo.exceptions import ValidationError, UserError, AccessError`

    **2. Update `addons/spora_segment/tests/__init__.py`:**

    Add: `from . import test_project_task_segment`
  </action>
  <verify>
    Verify Python syntax: `python3 -c "import ast; ast.parse(open('addons/spora_segment/tests/test_project_task_segment.py').read()); print('OK')"`

    Verify __init__.py has all 3 test imports.
  </verify>
  <done>
    - test_project_task_segment.py exists with ~19 test methods covering all PROJ and SEC requirements
    - Tests for cross-order segments verify onchange returns warning dict (not ValidationError) and confirm tasks can be saved despite warning
    - Tests for deletion protection and sale_order_id change still use assertRaises (UserError/ValidationError respectively)
    - __init__.py imports all test modules
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute all tests in Docker and fix any failures</name>
  <files>
    addons/spora_segment/tests/test_project_task_segment.py
  </files>
  <action>
    **1. Reinstall module with project dependency:**

    Since __manifest__.py now depends on 'project', the module needs updating. If project module is not installed yet, install it first:

    ```bash
    docker compose restart odoo && sleep 5
    docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init 2>&1 | tail -30
    ```

    If this fails because 'project' module isn't installed:
    ```bash
    docker compose exec odoo odoo -d spora -i project --stop-after-init 2>&1 | tail -10
    docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init 2>&1 | tail -30
    ```

    **2. Run Phase 3 tests:**

    Execute via Odoo shell (the pattern established in Phase 1/2):
    ```bash
    docker compose exec odoo odoo shell -d spora --no-http <<'EOF'
    import unittest
    from odoo.tests import tagged
    loader = unittest.TestLoader()
    suite = loader.loadTestsFromName('odoo.addons.spora_segment.tests.test_project_task_segment')
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    EOF
    ```

    **3. Run ALL tests (regression):**

    Run Phase 1, Phase 2, AND Phase 3 tests together:
    ```bash
    docker compose exec odoo odoo shell -d spora --no-http <<'EOF'
    import unittest
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()
    suite.addTests(loader.loadTestsFromName('odoo.addons.spora_segment.tests.test_sale_order_segment'))
    suite.addTests(loader.loadTestsFromName('odoo.addons.spora_segment.tests.test_sale_order_integration'))
    suite.addTests(loader.loadTestsFromName('odoo.addons.spora_segment.tests.test_project_task_segment'))
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    EOF
    ```

    **4. Fix any failures:**

    If tests fail, analyze the error output and fix. Common issues to watch for:
    - AccessError in security tests: check record rule domain syntax, check user group assignment
    - Onchange not returning warning: check method name matches, verify task created via `.new()` not `.create()`, check field values in test data
    - ValidationError not raised in sale_order_id change test: check constraint decorator field list, check field values in test data
    - UserError not raised in deletion test: check @api.ondelete method, check search domain
    - project.task form view errors: check xpath expression matches actual Odoo 18 view structure
    - Missing 'project' module: install it first, then update spora_segment

    Follow Rule 1 (auto-fix) for bugs discovered during testing. Commit fixes separately.

    **5. Verify all 3 test suites pass with 0 failures:**

    Expected: ~26 (Phase 1) + ~18 (Phase 2) + ~19 (Phase 3) = ~63 total tests, all passing.
  </action>
  <verify>
    All test suites pass with 0 failures and 0 errors:
    - test_sale_order_segment.py: 26 tests OK
    - test_sale_order_integration.py: 18 tests OK
    - test_project_task_segment.py: ~19 tests OK
    - Total: ~63 total tests, 0 failures, 0 errors
  </verify>
  <done>
    - All Phase 3 tests pass covering PROJ-01, PROJ-02, PROJ-03, SEC-01, SEC-02, SEC-03, SEC-04
    - All Phase 1 and Phase 2 tests still pass (zero regressions)
    - Module installs and updates cleanly in Odoo 18 Docker
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **All tests pass:** 0 failures, 0 errors across all 3 test files
2. **No regressions:** Phase 1 (26 tests) + Phase 2 (18 tests) still pass
3. **Phase 3 coverage:** All PROJ and SEC requirements have at least 1 test
4. **Docker verified:** Tests executed in actual Odoo 18 Docker environment

Requirement coverage matrix:
- PROJ-01 (segment_id on task): 4 tests (field exists, valid, optional, manual project)
- PROJ-02 (visible in form): Covered by module installation + view XML validation
- PROJ-03 (cross-order validation): 4 tests (onchange warning, can save despite warning, no warning for same order, no warning without sale_order)
- SEC-01 (ir.model.access.csv): Verified by Phase 1, unchanged
- SEC-02 (Sales User create/read): 2 tests (create own, read all)
- SEC-03 (Sales Manager CRUD): 1 test (full CRUD)
- SEC-04 (respect parent order): 1 test (cannot write other's order segments)
</verification>

<success_criteria>
- All ~63 tests pass (Phase 1 + Phase 2 + Phase 3) with 0 failures and 0 errors
- Every PROJ and SEC requirement has at least one test validating it
- Tests cover positive cases (valid operations succeed), negative cases (invalid operations blocked via ValidationError/UserError), and advisory cases (cross-order segment triggers onchange warning but task saves successfully)
- Security tests verify role-based access using actual Odoo users with correct groups
- Module remains installable after test file additions
</success_criteria>

<output>
After completion, create `.planning/phases/03-project-extension-security/03-02-SUMMARY.md`
</output>
