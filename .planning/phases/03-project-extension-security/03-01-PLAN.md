---
phase: 03-project-extension-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/spora_segment/models/project_task.py
  - addons/spora_segment/models/project_project.py
  - addons/spora_segment/models/sale_order_segment.py
  - addons/spora_segment/models/__init__.py
  - addons/spora_segment/__manifest__.py
  - addons/spora_segment/views/project_task_views.xml
  - addons/spora_segment/security/segment_security.xml
autonomous: true

must_haves:
  truths:
    - "User sees 'Budget Segment' field in project task form when project is linked to a sale order"
    - "User does NOT see segment_id field when project has no sale_order_id"
    - "System shows modal warning popup when segment does not belong to project's sale order (user can acknowledge and proceed)"
    - "System blocks deleting segment that has linked project tasks (UserError)"
    - "System blocks changing project's sale_order_id when tasks have segment references (ValidationError)"
    - "Segment dropdown shows 'SO001 / Segment Name' display format"
  artifacts:
    - path: "addons/spora_segment/models/project_task.py"
      provides: "project.task extension with segment_id and cross-order onchange warning"
      contains: "_inherit = 'project.task'"
    - path: "addons/spora_segment/models/project_project.py"
      provides: "project.project extension blocking sale_order_id change with segment tasks"
      contains: "_inherit = 'project.project'"
    - path: "addons/spora_segment/views/project_task_views.xml"
      provides: "Task form view inheritance with conditional segment_id field"
      contains: "project_task_form_inherit_segment"
    - path: "addons/spora_segment/security/segment_security.xml"
      provides: "Record rules for Sales User read-only on non-owned orders"
      contains: "ir.rule"
  key_links:
    - from: "addons/spora_segment/models/project_task.py"
      to: "sale.order.segment"
      via: "segment_id Many2one field"
      pattern: "fields\\.Many2one.*sale\\.order\\.segment"
    - from: "addons/spora_segment/views/project_task_views.xml"
      to: "project.view_task_form2"
      via: "inherit_id view extension"
      pattern: "inherit_id.*project\\.view_task_form2"
    - from: "addons/spora_segment/models/sale_order_segment.py"
      to: "project.task"
      via: "@api.ondelete checking for linked tasks"
      pattern: "ondelete.*project\\.task"
---

<objective>
Extend project.task with segment_id field for traceability, add display_name to segments, implement cross-model validations (segment-order, deletion protection, sale_order_id change block), create task form view with conditional visibility, and define record-level security rules.

Purpose: Establishes the infrastructure connecting project tasks to budget segments, preparing for Phase 4's automatic task creation while ensuring data integrity and proper access controls.
Output: Working project.task extension with segment_id visible in task form, validation constraints, deletion protection, and security rules - all installable in Odoo 18.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-project-extension-security/03-CONTEXT.md
@.planning/phases/03-project-extension-security/03-RESEARCH.md
@.planning/phases/02-sale-order-integration/02-01-SUMMARY.md

Key existing code to reference:
@addons/spora_segment/models/sale_order_segment.py
@addons/spora_segment/models/sale_order.py
@addons/spora_segment/models/__init__.py
@addons/spora_segment/__manifest__.py
@addons/spora_segment/security/ir.model.access.csv
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project.task and project.project model extensions with segment validations</name>
  <files>
    addons/spora_segment/models/project_task.py
    addons/spora_segment/models/project_project.py
    addons/spora_segment/models/sale_order_segment.py
    addons/spora_segment/models/__init__.py
  </files>
  <action>
    **1. Create `addons/spora_segment/models/project_task.py`:**

    Extend project.task with `_inherit = 'project.task'`:

    - `segment_id = fields.Many2one('sale.order.segment', string='Budget Segment', index=True, ondelete='restrict')` — optional field, ondelete='restrict' to prevent segment deletion (database-level backup for the Python ondelete decorator)
    - Add help text: 'Reference to the originating budget segment. Only visible for projects linked to sale orders.'

    Add cross-order warning via onchange (NOT @api.constrains — user must be able to proceed after acknowledging):
    ```python
    @api.onchange('segment_id', 'project_id')
    def _onchange_segment_order_warning(self):
        """Warn user when segment does not belong to project's sale order.

        Returns a warning dict that Odoo displays as a modal popup with
        an OK button. User clicks OK, warning disappears, and the save
        proceeds normally. This is NOT a hard block — it's advisory.
        """
        if self.segment_id and self.project_id and self.project_id.sale_order_id:
            if self.segment_id.order_id != self.project_id.sale_order_id:
                return {
                    'warning': {
                        'title': 'Advertencia: Segmento de otro presupuesto',
                        'message': (
                            'El segmento "%s" no pertenece al presupuesto de este proyecto. '
                            'Esto puede causar inconsistencias.'
                        ) % self.segment_id.display_name,
                    }
                }
    ```

    Do NOT import ValidationError for this — onchange warnings use return dict, not exceptions. Only import what's needed: `from odoo import models, fields, api`.

    **2. Create `addons/spora_segment/models/project_project.py`:**

    Extend project.project with `_inherit = 'project.project'`:

    Add constraint to block sale_order_id changes when tasks have segment references:
    ```python
    @api.constrains('sale_order_id')
    def _check_sale_order_change_with_segments(self):
        """Prevent changing sale_order_id if tasks have segment references."""
        for project in self:
            # Only block if sale_order_id is being changed (not cleared completely)
            # We need to check if any tasks have segment_id set
            task_with_segment = self.env['project.task'].search_count([
                ('project_id', '=', project.id),
                ('segment_id', '!=', False)
            ])
            if task_with_segment > 0:
                raise ValidationError(
                    'No se puede cambiar el presupuesto del proyecto "%s" porque '
                    'contiene tareas vinculadas a segmentos. '
                    'Elimine las referencias a segmentos de las tareas primero.'
                    % project.name
                )
    ```

    Import: `from odoo import models, api` and `from odoo.exceptions import ValidationError`

    IMPORTANT: The constraint fires on ANY write to sale_order_id. We want to allow the INITIAL set (when project is created). The constraint should check if there are tasks with segment_id. If the project is being created (no id yet), skip. But @api.constrains only fires after create/write, so project.id will exist. The check is correct: if tasks with segment_id exist, block the change. On initial creation, no tasks exist yet, so it won't block.

    **3. Modify `addons/spora_segment/models/sale_order_segment.py`:**

    Add two things:

    a) Add `display_name` computed field override for "SO001 / Segment Name" format:
    ```python
    def _compute_display_name(self):
        """Display as 'SO001 / Segment Name' for better identification in task form."""
        for segment in self:
            if segment.order_id:
                segment.display_name = '%s / %s' % (segment.order_id.name, segment.name)
            else:
                segment.display_name = segment.name
    ```

    Note: In Odoo 18, override `_compute_display_name` method (not name_get which is deprecated). This is the standard pattern. No decorator needed — Odoo calls it automatically.

    b) Add `@api.ondelete(at_uninstall=False)` method to prevent deletion when tasks exist:
    ```python
    @api.ondelete(at_uninstall=False)
    def _unlink_if_no_tasks(self):
        """Prevent deletion if project tasks reference this segment."""
        task_count = self.env['project.task'].search_count([('segment_id', 'in', self.ids)])
        if task_count > 0:
            raise UserError(
                'No se puede eliminar segmento(s) porque están referenciados por tareas de proyecto. '
                'Elimine las referencias a segmentos de las tareas primero, o elimine las tareas.'
            )
    ```

    Add `UserError` to the imports from odoo.exceptions (already imports ValidationError).

    **4. Update `addons/spora_segment/models/__init__.py`:**

    Add imports for the two new model files:
    ```python
    from . import sale_order_segment
    from . import sale_order
    from . import sale_order_line
    from . import project_task
    from . import project_project
    ```
  </action>
  <verify>
    Run: `python3 -c "import ast; ast.parse(open('addons/spora_segment/models/project_task.py').read()); print('project_task.py: OK')"` for each new file to verify Python syntax is valid.

    Verify imports in __init__.py include all 5 model files.
  </verify>
  <done>
    - project_task.py exists with segment_id Many2one + _onchange_segment_order_warning (returns warning dict, not ValidationError)
    - project_project.py exists with _check_sale_order_change_with_segments constraint
    - sale_order_segment.py has _compute_display_name and _unlink_if_no_tasks methods
    - __init__.py imports all 5 model modules
  </done>
</task>

<task type="auto">
  <name>Task 2: Create task form view, security record rules, and update manifest</name>
  <files>
    addons/spora_segment/views/project_task_views.xml
    addons/spora_segment/security/segment_security.xml
    addons/spora_segment/__manifest__.py
  </files>
  <action>
    **1. Create `addons/spora_segment/views/project_task_views.xml`:**

    Inherit project task form view to add segment_id field:

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <odoo>

        <!-- Inherit project task form view to add segment_id -->
        <record id="project_task_form_inherit_segment" model="ir.ui.view">
            <field name="name">project.task.form.inherit.segment</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_form2"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='project_id']" position="after">
                    <field name="segment_id"
                           string="Budget Segment"
                           invisible="not project_id or not project_id.sale_order_id"
                           domain="[('order_id', '=', project_id.sale_order_id)]"
                           options="{'no_create': True, 'no_open': True}"/>
                </xpath>
            </field>
        </record>

    </odoo>
    ```

    Key points:
    - `invisible="not project_id or not project_id.sale_order_id"` — hides field for manual projects
    - `domain="[('order_id', '=', project_id.sale_order_id)]"` — filters segments to current project's order
    - `options="{'no_create': True, 'no_open': True}"` — prevents creating segments from task form (segments managed from sale order)
    - Position after project_id field per user decision (near project_id and parent_id)
    - Uses Odoo 18 inline expression syntax for invisible (not legacy attrs={} format)

    **2. Create `addons/spora_segment/security/segment_security.xml`:**

    Define record rules for segment access based on sale order ownership:

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <odoo>

        <!-- Record rule: Sales Users can only write segments on their own orders -->
        <record id="segment_rule_salesman_write" model="ir.rule">
            <field name="name">Segments: Sales Users edit own orders only</field>
            <field name="model_id" ref="model_sale_order_segment"/>
            <field name="groups" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="0"/>
            <field name="domain_force">[
                '|',
                ('order_id.user_id', '=', user.id),
                ('order_id.user_id', '=', False)
            ]</field>
        </record>

        <!-- Record rule: Sales Managers have full access to all segments -->
        <record id="segment_rule_manager_all" model="ir.rule">
            <field name="name">Segments: Sales Managers full access</field>
            <field name="model_id" ref="model_sale_order_segment"/>
            <field name="groups" eval="[(4, ref('sales_team.group_sale_manager'))]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

    </odoo>
    ```

    The Sales User rule allows read/write/create on segments belonging to:
    - Orders assigned to them (order_id.user_id = current user)
    - Orders with no assigned user (unassigned orders)

    Sales User CANNOT unlink (delete) segments (perm_unlink=0), which matches the ir.model.access.csv from Phase 1.

    Sales Manager gets full CRUD via domain [(1, '=', 1)] (always true).

    Note: Read access for ALL segments (even other users' orders) is handled by the ir.model.access.csv already granting read=1. Record rules are additive within a group — the Odoo security model means if ANY rule grants access, it's granted. The salesman rule restricts write/create to own orders while allowing read on all (since ir.model.access grants base read).

    IMPORTANT: Actually, record rules are RESTRICTIVE — they filter records. A user can only see records matching at least one rule for their group. So the salesman rule above with the write domain would also restrict READ to only own orders' segments. This is NOT what we want per the user decision: "puede ver segments/tasks pero no editar."

    CORRECTION: We need separate read and write rules for Sales Users:

    ```xml
    <!-- Record rule: Sales Users can read ALL segments -->
    <record id="segment_rule_salesman_read" model="ir.rule">
        <field name="name">Segments: Sales Users read all</field>
        <field name="model_id" ref="model_sale_order_segment"/>
        <field name="groups" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="0"/>
        <field name="perm_create" eval="0"/>
        <field name="perm_unlink" eval="0"/>
        <field name="domain_force">[(1, '=', 1)]</field>
    </record>

    <!-- Record rule: Sales Users can write/create segments on own orders -->
    <record id="segment_rule_salesman_write" model="ir.rule">
        <field name="name">Segments: Sales Users edit own orders only</field>
        <field name="model_id" ref="model_sale_order_segment"/>
        <field name="groups" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
        <field name="perm_read" eval="0"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="0"/>
        <field name="domain_force">[
            '|',
            ('order_id.user_id', '=', user.id),
            ('order_id.user_id', '=', False)
        ]</field>
    </record>
    ```

    Use this corrected version with two separate rules for Sales Users.

    **3. Update `addons/spora_segment/__manifest__.py`:**

    - Add `'project'` to the `depends` list (needed for project.task and project.project models)
    - Add `'views/project_task_views.xml'` to `data` list
    - Add `'security/segment_security.xml'` to `data` list

    Final depends: `['sale', 'project']`
    Final data: `['security/ir.model.access.csv', 'security/segment_security.xml', 'views/sale_order_segment_views.xml', 'views/sale_order_views.xml', 'views/project_task_views.xml']`

    IMPORTANT: `segment_security.xml` must come AFTER `ir.model.access.csv` in the data list because record rules reference model IDs that must exist first. But actually, `ir.model.access.csv` creates access entries, while `segment_security.xml` creates ir.rule records. Both reference `model_sale_order_segment` which is registered when the module loads. The order within data list matters: security files should come before view files.
  </action>
  <verify>
    Verify XML syntax for both new XML files:
    ```bash
    python3 -c "import xml.etree.ElementTree as ET; ET.parse('addons/spora_segment/views/project_task_views.xml'); print('project_task_views.xml: OK')"
    python3 -c "import xml.etree.ElementTree as ET; ET.parse('addons/spora_segment/security/segment_security.xml'); print('segment_security.xml: OK')"
    ```

    Verify __manifest__.py has 'project' in depends and all files in data list.

    Run module update in Docker to verify installation:
    ```bash
    docker compose restart odoo && sleep 5
    docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init 2>&1 | tail -20
    ```

    Check for errors in the output. Success = "INFO ... Modules loaded." without errors.
  </verify>
  <done>
    - project_task_views.xml exists with inherited form view, segment_id conditionally visible
    - segment_security.xml exists with 3 record rules (salesman read, salesman write, manager full)
    - __manifest__.py has 'project' dependency and lists all data files
    - Module installs/updates in Odoo 18 Docker without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Module installs cleanly:** `docker compose exec odoo odoo -d spora -u spora_segment --stop-after-init` completes without errors
2. **Python syntax valid:** All .py files parse without SyntaxError
3. **XML syntax valid:** All .xml files parse without errors
4. **Field exists:** segment_id field on project.task model (verify via Odoo shell: `self.env['project.task']._fields['segment_id']`)
5. **Display name works:** Segment display_name shows "SO001 / Segment Name" format
6. **Onchange warning fires:** Selecting segment from wrong order triggers warning popup (user can dismiss and proceed)
</verification>

<success_criteria>
- project.task has segment_id Many2one field (optional, indexed, ondelete='restrict')
- Task form shows segment_id when project has sale_order_id, hidden otherwise
- Segment dropdown filters by project's sale order
- Cross-order validation shows modal warning popup (onchange, not constrains) — user can acknowledge and proceed
- Segment deletion blocked when tasks exist (UserError)
- Project sale_order_id change blocked when tasks have segment_id (ValidationError)
- Segment display_name shows "Order / Segment Name"
- Security rules: Sales User reads all, writes own; Sales Manager full CRUD
- Module installs in Odoo 18 without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-project-extension-security/03-01-SUMMARY.md`
</output>
