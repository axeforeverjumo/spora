---
phase: 05-user-experience-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - addons/spora_segment/views/sale_order_segment_views.xml
  - addons/spora_segment/tests/test_ux_enhancements.py
autonomous: true

must_haves:
  truths:
    - "Tree view shows color-coded rows by hierarchy level (L1=primary, L2=info, L3=muted, L4=warning)"
    - "Tree view displays full_path column for breadcrumb navigation"
    - "Tree view shows product count with monetary subtotal"
    - "Smart button displays child count AND depth levels"
    - "Drag-and-drop handle works for sibling reordering"
  artifacts:
    - path: "addons/spora_segment/views/sale_order_segment_views.xml"
      provides: "Enhanced list/form views with decorations, full_path, product_count display"
      contains: "decoration-primary"
    - path: "addons/spora_segment/tests/test_ux_enhancements.py"
      provides: "Tests for full_path, child_depth, product_count computed fields"
      contains: "def test_full_path_computation"
  key_links:
    - from: "list view"
      to: "level field"
      via: "decoration attributes"
      pattern: "decoration-primary=\"level == 1\""
    - from: "smart button"
      to: "child_depth field"
      via: "inline display"
      pattern: "child_depth"
---

<objective>
Enhance segment views with visual hierarchy feedback and create UX tests

Purpose: Complete the user experience improvements by adding color-coded decorations to list view, displaying full_path and product_count columns, enhancing smart button with depth info, and testing all computed fields.

Output: Updated sale_order_segment_views.xml with UX enhancements, test_ux_enhancements.py with comprehensive tests
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-experience-polish/05-CONTEXT.md
@.planning/phases/05-user-experience-polish/05-RESEARCH.md
@.planning/phases/05-user-experience-polish/05-01-SUMMARY.md
@addons/spora_segment/models/sale_order_segment.py
@addons/spora_segment/views/sale_order_segment_views.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance list view with decorations, full_path, and product_count</name>
  <files>addons/spora_segment/views/sale_order_segment_views.xml</files>
  <action>
Update the list view (sale_order_segment_view_tree) with visual enhancements:

1. Add decoration attributes to the `<list>` tag:
```xml
<list decoration-primary="level == 1"
      decoration-info="level == 2"
      decoration-muted="level == 3"
      decoration-warning="level == 4">
```

User decision colors from CONTEXT.md:
- Level 1 (epics): decoration-primary (blue/purple)
- Level 2 (tasks): decoration-info (light blue)
- Level 3 (subtasks): decoration-muted (gray)
- Level 4 (deepest): decoration-warning (yellow/orange)

2. Add `full_path` column after `name`:
```xml
<field name="full_path"/>
```

3. Add `product_count` column (before subtotal):
```xml
<field name="product_count" string="Products"/>
```

4. Make `level` column hidden but available for decorations:
```xml
<field name="level" column_invisible="1"/>
```

5. Remove `parent_id` and `order_id` columns (redundant with full_path showing hierarchy context, and view is already filtered by order from sale order form).

Final list view structure:
```xml
<list decoration-primary="level == 1"
      decoration-info="level == 2"
      decoration-muted="level == 3"
      decoration-warning="level == 4">
    <field name="sequence" widget="handle"/>
    <field name="name"/>
    <field name="full_path"/>
    <field name="child_count"/>
    <field name="product_count" string="Products"/>
    <field name="subtotal" sum="Subtotal"/>
    <field name="total" sum="Total"/>
    <field name="level" column_invisible="1"/>
</list>
```
  </action>
  <verify>
After module upgrade, open segment list view and verify:
- Root segments (level 1) appear in primary color
- Child segments (level 2) appear in info color
- Level 3+ segments appear in muted/warning colors
- full_path column shows hierarchy breadcrumb
- Products column shows count
  </verify>
  <done>List view displays color-coded rows by level, shows full_path and product_count columns</done>
</task>

<task type="auto">
  <name>Task 2: Enhance smart button to show depth levels</name>
  <files>addons/spora_segment/views/sale_order_segment_views.xml</files>
  <action>
Update the smart button in form view to display child count AND depth levels:

User decision from CONTEXT.md: Show "X Sub-segmentos (Y niveles)"

Update the button structure in form view:
```xml
<button name="action_view_children"
        type="object"
        class="oe_stat_button"
        icon="fa-sitemap"
        invisible="child_count == 0">
    <div class="o_stat_info">
        <span class="o_stat_value">
            <field name="child_count"/>
        </span>
        <span class="o_stat_text">Sub-segmentos</span>
    </div>
    <div class="o_stat_info" invisible="child_depth == 0">
        <span class="o_stat_text">
            (<field name="child_depth" readonly="1"/> niveles)
        </span>
    </div>
</button>
```

Key patterns from RESEARCH.md:
- Use `o_stat_info` class for proper alignment
- Show depth only if > 0 (leaves have no depth info)
- Use readonly="1" for inline display fields

Also add `full_path` as readonly field in the form view (second group):
```xml
<field name="full_path" readonly="1"/>
```
  </action>
  <verify>
After module upgrade, open segment form view and verify:
- Smart button shows "X Sub-segmentos" with count
- Smart button shows "(Y niveles)" for non-leaf segments
- Button hidden when child_count = 0
- full_path field visible in form
  </verify>
  <done>Smart button displays both child count and depth levels, form shows full_path</done>
</task>

<task type="auto">
  <name>Task 3: Create UX enhancement tests</name>
  <files>addons/spora_segment/tests/test_ux_enhancements.py</files>
  <action>
Create new test file for UX computed fields:

```python
from odoo.tests import TransactionCase, tagged


@tagged('post_install', '-at_install')
class TestUxEnhancements(TransactionCase):
    """Tests for Phase 5 UX enhancements: full_path, child_depth, product_count."""

    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        # Create sale order for testing
        cls.partner = cls.env['res.partner'].create({'name': 'UX Test Partner'})
        cls.product = cls.env['product.product'].create({
            'name': 'UX Test Product',
            'type': 'service',
            'list_price': 100.0,
        })
        cls.order = cls.env['sale.order'].create({
            'partner_id': cls.partner.id,
        })

        # Create hierarchical segments: Root -> Child -> Grandchild
        cls.root_segment = cls.env['sale.order.segment'].create({
            'name': 'Root Segment',
            'order_id': cls.order.id,
        })
        cls.child_segment = cls.env['sale.order.segment'].create({
            'name': 'Child Segment',
            'order_id': cls.order.id,
            'parent_id': cls.root_segment.id,
        })
        cls.grandchild_segment = cls.env['sale.order.segment'].create({
            'name': 'Grandchild Segment',
            'order_id': cls.order.id,
            'parent_id': cls.child_segment.id,
        })

    def test_full_path_computation(self):
        """UX-02: full_path shows complete hierarchy with / separator."""
        self.assertEqual(self.root_segment.full_path, 'Root Segment')
        self.assertEqual(self.child_segment.full_path, 'Root Segment / Child Segment')
        self.assertEqual(
            self.grandchild_segment.full_path,
            'Root Segment / Child Segment / Grandchild Segment'
        )

    def test_full_path_cascade_on_parent_rename(self):
        """UX-02: full_path updates when ancestor name changes."""
        # Rename root segment
        self.root_segment.name = 'Renamed Root'

        # Invalidate cache to ensure recomputation
        self.child_segment.invalidate_recordset(['full_path'])
        self.grandchild_segment.invalidate_recordset(['full_path'])

        # Verify cascade
        self.assertEqual(self.child_segment.full_path, 'Renamed Root / Child Segment')
        self.assertEqual(
            self.grandchild_segment.full_path,
            'Renamed Root / Child Segment / Grandchild Segment'
        )

    def test_child_depth_computation(self):
        """UX-05: child_depth shows maximum descendant depth."""
        # Grandchild has no children -> depth = 0
        self.assertEqual(self.grandchild_segment.child_depth, 0)

        # Child has one level of children -> depth = 1
        self.assertEqual(self.child_segment.child_depth, 1)

        # Root has two levels of descendants -> depth = 2
        self.assertEqual(self.root_segment.child_depth, 2)

    def test_child_depth_updates_on_hierarchy_change(self):
        """UX-05: child_depth updates when adding/removing children."""
        # Add great-grandchild
        great_grandchild = self.env['sale.order.segment'].create({
            'name': 'Great-grandchild',
            'order_id': self.order.id,
            'parent_id': self.grandchild_segment.id,
        })

        # Invalidate and check cascade
        self.grandchild_segment.invalidate_recordset(['child_depth'])
        self.child_segment.invalidate_recordset(['child_depth'])
        self.root_segment.invalidate_recordset(['child_depth'])

        self.assertEqual(self.grandchild_segment.child_depth, 1)
        self.assertEqual(self.child_segment.child_depth, 2)
        self.assertEqual(self.root_segment.child_depth, 3)

        # Remove great-grandchild and verify depth decreases
        great_grandchild.unlink()

        self.grandchild_segment.invalidate_recordset(['child_depth'])
        self.child_segment.invalidate_recordset(['child_depth'])
        self.root_segment.invalidate_recordset(['child_depth'])

        self.assertEqual(self.grandchild_segment.child_depth, 0)
        self.assertEqual(self.child_segment.child_depth, 1)
        self.assertEqual(self.root_segment.child_depth, 2)

    def test_product_count_computation(self):
        """UX-06: product_count shows count of directly assigned products."""
        # Initially no products
        self.assertEqual(self.root_segment.product_count, 0)

        # Add order line to root segment
        self.env['sale.order.line'].create({
            'order_id': self.order.id,
            'product_id': self.product.id,
            'product_uom_qty': 2,
            'segment_id': self.root_segment.id,
        })

        # Invalidate and verify
        self.root_segment.invalidate_recordset(['product_count'])
        self.assertEqual(self.root_segment.product_count, 1)

        # Add another line
        self.env['sale.order.line'].create({
            'order_id': self.order.id,
            'product_id': self.product.id,
            'product_uom_qty': 3,
            'segment_id': self.root_segment.id,
        })

        self.root_segment.invalidate_recordset(['product_count'])
        self.assertEqual(self.root_segment.product_count, 2)

    def test_product_count_only_direct_not_children(self):
        """UX-06: product_count counts only direct products, not children's."""
        # Add product to child segment
        self.env['sale.order.line'].create({
            'order_id': self.order.id,
            'product_id': self.product.id,
            'product_uom_qty': 1,
            'segment_id': self.child_segment.id,
        })

        # Root should have 0 (not counting child's products)
        self.root_segment.invalidate_recordset(['product_count'])
        self.assertEqual(self.root_segment.product_count, 0)

        # Child should have 1
        self.child_segment.invalidate_recordset(['product_count'])
        self.assertEqual(self.child_segment.product_count, 1)

    def test_child_count_stored(self):
        """UX: child_count is stored for instant reads."""
        # Verify child_count field has store=True by checking it's stored
        field = self.env['sale.order.segment']._fields['child_count']
        self.assertTrue(field.store, "child_count should be stored for performance")

    def test_full_path_stored(self):
        """UX-02: full_path is stored for sorting/filtering."""
        field = self.env['sale.order.segment']._fields['full_path']
        self.assertTrue(field.store, "full_path should be stored for performance")

    def test_child_depth_stored(self):
        """UX-05: child_depth is stored for instant reads."""
        field = self.env['sale.order.segment']._fields['child_depth']
        self.assertTrue(field.store, "child_depth should be stored for performance")
```

Add import in `addons/spora_segment/tests/__init__.py`:
```python
from . import test_ux_enhancements
```
  </action>
  <verify>
Run tests:
```bash
docker compose exec odoo odoo -d odoo -u spora_segment --test-tags=spora_segment --stop-after-init -c /etc/odoo/odoo.conf 2>&1 | grep -E "(OK|FAIL|ERROR|test_)"
```
Or via Odoo shell:
```python
from odoo.tests.loader import get_test_modules
env.cr.execute("SELECT 1")  # Ensure connection
```
  </verify>
  <done>All UX tests pass: full_path, child_depth, product_count computed correctly</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Upgrade module:
```bash
docker compose exec odoo odoo -d odoo -u spora_segment --stop-after-init -c /etc/odoo/odoo.conf
```

2. Run tests:
```bash
docker compose exec odoo odoo -d odoo --test-tags=spora_segment --stop-after-init -c /etc/odoo/odoo.conf
```

3. Visual verification in browser:
- Navigate to Sales > Segments
- Verify rows are color-coded by level
- Verify full_path column shows breadcrumb
- Verify Products column shows count
- Open segment form, verify smart button shows count + levels
- Test drag-drop on sequence handles (should reorder siblings only)

4. Verify requirements coverage:
- UX-01: decorations by level (visual)
- UX-02: full_path column in list (visual + test)
- UX-03: handle widget exists (already present, visual verify)
- UX-04: smart button child count (visual)
- UX-05: smart button depth levels (visual + test)
- UX-06: product_count + subtotal (visual + test)
</verification>

<success_criteria>
- [ ] List view rows are color-coded by level (1=primary, 2=info, 3=muted, 4=warning)
- [ ] List view shows full_path column with "/" separator
- [ ] List view shows product_count column
- [ ] Form view smart button shows "X Sub-segmentos (Y niveles)"
- [ ] Form view shows full_path as readonly field
- [ ] All 10 tests pass (test_ux_enhancements.py)
- [ ] Module upgrade succeeds without errors
- [ ] Drag-drop handle works for sibling reordering
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-experience-polish/05-02-SUMMARY.md`
</output>
