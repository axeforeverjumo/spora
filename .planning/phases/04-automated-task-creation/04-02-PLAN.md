---
phase: 04-automated-task-creation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - addons/spora_segment/tests/test_automated_task_creation.py
  - addons/spora_segment/tests/__init__.py
autonomous: true

must_haves:
  truths:
    - "AUTO-01 through AUTO-12 documented with test coverage (AUTO-08/09 explicitly deferred to Phase 5)"
    - "Tests verify task creation maintains segment hierarchy"
    - "Tests verify idempotence (no duplicates on re-confirm)"
    - "Tests verify savepoint isolation (one failure doesn't affect others)"
    - "Tests verify data transfer (name, description, hours, segment_id)"
    - "AUTO-08/09 tests verify graceful handling when fields don't exist (no errors)"
    - "All tests pass in Docker environment"
  artifacts:
    - path: "addons/spora_segment/tests/test_automated_task_creation.py"
      provides: "Comprehensive test suite for AUTO requirements"
      contains: "class TestAutomatedTaskCreation"
      min_lines: 200
  key_links:
    - from: "test_automated_task_creation.py"
      to: "sale.order.action_confirm()"
      via: "Test method calls"
      pattern: "order\\.action_confirm\\(\\)"
    - from: "test methods"
      to: "AUTO-XX requirements"
      via: "Requirement coverage"
      pattern: "AUTO-\\d{2}"
---

<objective>
Create comprehensive test suite for automatic task creation workflow

Purpose: Validate all AUTO requirements (01-12) with automated tests, ensuring the implementation handles hierarchy, idempotence, error isolation, and data transfer correctly.

Output: Test file with ~20 test methods covering all AUTO requirements, verified passing in Docker.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-automated-task-creation/04-CONTEXT.md
@.planning/phases/04-automated-task-creation/04-01-PLAN.md
@addons/spora_segment/models/sale_order.py
@addons/spora_segment/tests/test_sale_order_segment.py
@addons/spora_segment/tests/test_project_task_segment.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive test suite for AUTO requirements</name>
  <files>addons/spora_segment/tests/test_automated_task_creation.py</files>
  <action>
Create a new test file following established patterns from test_project_task_segment.py.

**Test class structure:**
```python
import logging
from odoo.tests import TransactionCase, tagged

_logger = logging.getLogger(__name__)

@tagged('post_install', '-at_install')
class TestAutomatedTaskCreation(TransactionCase):
    """Test automatic task creation from segments when confirming sale orders."""

    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        # Setup test data...
```

**setUp pattern (from existing tests):**
- Create service product (type='service')
- Create test partner
- Create sale order
- Create hierarchical segments (4 levels to test full depth)
- Create order lines assigned to segments

**Test methods to implement:**

**AUTO-01: Project creation (2 tests)**
- `test_confirm_creates_project_if_not_exists`: Verify project exists after confirm (Odoo handles this)
- `test_confirm_with_existing_project_uses_it`: Verify existing project is used

**AUTO-02: Task per segment (2 tests)**
- `test_confirm_creates_task_per_segment`: Count tasks = count segments
- `test_confirm_only_creates_tasks_for_segments_with_order`: Tasks only for this order's segments

**AUTO-03: Task parent_id hierarchy (3 tests)**
- `test_child_segment_task_has_parent_id`: Level 2 segment's task.parent_id = level 1 task
- `test_grandchild_segment_task_hierarchy`: Level 3 task.parent_id = level 2 task
- `test_deep_hierarchy_preserved`: 4 levels of segments create 4-level task hierarchy

**AUTO-04: Root tasks (1 test)**
- `test_root_segment_task_no_parent`: Level 1 segment's task.parent_id is False

**AUTO-05: Name transfer (1 test)**
- `test_task_name_equals_segment_name`: task.name == segment.name

**AUTO-06: Products to description (2 tests)**
- `test_task_description_contains_products`: Description includes product names/quantities
- `test_empty_segment_description`: Segment without products has minimal description

**AUTO-07: Planned hours calculation (2 tests)**
- `test_planned_hours_equals_product_quantities`: Sum of product_uom_qty
- `test_planned_hours_zero_for_empty_segment`: No products = 0 hours

**AUTO-08: Responsible transfer (1 test) - DEFERRED to Phase 5**
- `test_responsible_transfer_deferred`: Verify code handles missing segment.user_id gracefully
- Test that task creation succeeds even when segment has no user_id field
- Document explicitly: "Deferred to Phase 5 - requires adding user_id field to segment model"

**AUTO-09: Date transfer (1 test) - DEFERRED to Phase 5**
- `test_date_transfer_deferred`: Verify code handles missing segment date fields gracefully
- Test that task creation succeeds even when segment has no date fields
- Document explicitly: "Deferred to Phase 5 - requires adding date fields to segment model"

**AUTO-10: Segment link (2 tests)**
- `test_task_segment_id_links_to_segment`: task.segment_id == segment
- `test_segment_id_unique_per_task`: No two tasks have same segment_id

**AUTO-11 & AUTO-12: Savepoint isolation (2 tests)**
- `test_savepoint_continues_on_error`: Mock one segment to fail, others still created
- `test_partial_failure_logged`: Error logged when one task fails (check log)

**Idempotence (3 tests)**
- `test_reconfirm_no_duplicates`: action_confirm() twice creates same task count
- `test_idempotence_with_existing_tasks`: If tasks exist, don't recreate
- `test_idempotence_preserves_task_data`: Re-confirm doesn't modify existing tasks

**Edge cases (3 tests)**
- `test_order_without_segments_no_tasks`: No segments = no segment tasks created
- `test_order_with_mixed_lines`: Lines with and without segment_id handled correctly
- `test_sibling_segments_independent`: Multiple root segments create independent task trees

**Implementation notes:**
- Use `self.env['project.task'].search([('segment_id', '=', segment.id)])` to find tasks
- Use `self.assertEqual`, `self.assertTrue`, `self.assertIn` assertions
- For savepoint tests, may need to mock `_create_task_with_savepoint` to simulate failure
- Reference test_project_task_segment.py for user creation and security context patterns
- Service products need service_tracking configured to create projects automatically
  </action>
  <verify>
```bash
# Python syntax check
docker compose exec odoo python3 -m py_compile /mnt/extra-addons/spora_segment/tests/test_automated_task_creation.py

# Quick import check
docker compose exec odoo python3 -c "from odoo.addons.spora_segment.tests import test_automated_task_creation; print('Import OK')"
```
  </verify>
  <done>
- test_automated_task_creation.py contains TestAutomatedTaskCreation class
- ~20 test methods covering all AUTO requirements
- Proper setUp with service products, segments, and order lines
- File passes Python syntax check
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests __init__.py and run all tests</name>
  <files>addons/spora_segment/tests/__init__.py</files>
  <action>
**1. Update tests/__init__.py to include new test module:**
Add import for test_automated_task_creation

**2. Run ALL tests in Docker to verify no regressions:**
```bash
docker compose exec odoo odoo shell --config=/etc/odoo/odoo.conf -d odoo <<'TESTSCRIPT'
import sys
from odoo.tests import TransactionCase, tagged
from odoo.addons.spora_segment.tests.test_sale_order_segment import TestSaleOrderSegment
from odoo.addons.spora_segment.tests.test_sale_order_integration import TestSaleOrderIntegration
from odoo.addons.spora_segment.tests.test_project_task_segment import TestProjectTaskSegment
from odoo.addons.spora_segment.tests.test_automated_task_creation import TestAutomatedTaskCreation

import unittest
loader = unittest.TestLoader()
suite = unittest.TestSuite()

# Load all test classes
suite.addTests(loader.loadTestsFromTestCase(TestSaleOrderSegment))
suite.addTests(loader.loadTestsFromTestCase(TestSaleOrderIntegration))
suite.addTests(loader.loadTestsFromTestCase(TestProjectTaskSegment))
suite.addTests(loader.loadTestsFromTestCase(TestAutomatedTaskCreation))

# Run tests
runner = unittest.TextTestRunner(verbosity=2, stream=sys.stdout)
result = runner.run(suite)

print(f"\n{'='*60}")
print(f"Tests run: {result.testsRun}")
print(f"Failures: {len(result.failures)}")
print(f"Errors: {len(result.errors)}")
print(f"{'='*60}")

if result.failures or result.errors:
    print("\n=== FAILURES ===")
    for test, trace in result.failures:
        print(f"{test}: {trace}")
    print("\n=== ERRORS ===")
    for test, trace in result.errors:
        print(f"{test}: {trace}")
    sys.exit(1)
else:
    print("\n=== ALL TESTS PASSED ===")
    sys.exit(0)
TESTSCRIPT
```

**3. Fix any failing tests:**
- If tests fail, analyze the error
- Fix implementation in sale_order.py if logic errors
- Fix test assertions if test expectations wrong
- Re-run until all tests pass

**Expected test count:**
- Phase 1: ~26 tests
- Phase 2: ~18 tests
- Phase 3: ~20 tests
- Phase 4: ~20 tests
- Total: ~84 tests
  </action>
  <verify>
```bash
# Verify import works
docker compose exec odoo python3 -c "from odoo.addons.spora_segment.tests import test_automated_task_creation; print('Import OK')"

# Run full test suite (should show ~84 tests passing)
```
  </verify>
  <done>
- tests/__init__.py includes test_automated_task_creation import
- All ~84 tests pass (Phase 1 + Phase 2 + Phase 3 + Phase 4)
- No regressions in existing tests
- Zero failures, zero errors
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Test file health:**
   - test_automated_task_creation.py has ~200+ lines
   - Python syntax valid
   - Module imports correctly

2. **Requirement coverage:**
   - AUTO-01 through AUTO-07, AUTO-10 through AUTO-12: Full test coverage
   - AUTO-08 and AUTO-09: Tests verify graceful handling (fields don't exist yet)
   - Deferred functionality explicitly documented in test docstrings

3. **Full test suite:**
   - All ~84 tests pass
   - No regressions in Phase 1/2/3 tests
   - Phase 4 tests all green

4. **Docker verification:**
   - Module upgrades cleanly
   - Tests run without errors in container
</verification>

<success_criteria>
- [ ] test_automated_task_creation.py exists with ~20 test methods
- [ ] AUTO-01-07, 10-12 have full test coverage; AUTO-08/09 test graceful handling of missing fields
- [ ] tests/__init__.py imports new test module
- [ ] Full test suite passes (~84 tests, 0 failures)
- [ ] No regressions in existing tests
- [ ] Implementation fixes applied if tests revealed issues
</success_criteria>

<output>
After completion, create `.planning/phases/04-automated-task-creation/04-02-SUMMARY.md`
</output>
