---
phase: 04-automated-task-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/spora_segment/models/sale_order.py
autonomous: true

must_haves:
  truths:
    - "When sale order with segments is confirmed, system creates one task per segment"
    - "Task hierarchy mirrors segment hierarchy (parent_id references parent segment's task)"
    - "Root segments (level 1) create tasks with no parent_id"
    - "Task.name equals segment.name"
    - "Task.description contains formatted product list from segment"
    - "Task.planned_hours equals sum of product quantities in segment"
    - "Task.segment_id links back to originating segment"
    - "Re-confirming sale order does not create duplicate tasks (idempotent)"
    - "If one task creation fails, other tasks are still created (savepoint isolation)"
  artifacts:
    - path: "addons/spora_segment/models/sale_order.py"
      provides: "action_confirm() override with segment-to-task conversion"
      exports: ["action_confirm", "_create_segment_tasks", "_prepare_task_values", "_format_products_description", "_create_task_with_savepoint", "_get_or_create_project"]
      min_lines: 100
  key_links:
    - from: "sale.order.action_confirm()"
      to: "sale.order._create_segment_tasks()"
      via: "Method call before super()"
      pattern: "_create_segment_tasks.*super.*action_confirm"
    - from: "sale.order._create_segment_tasks()"
      to: "project.task.create()"
      via: "ORM create with savepoint"
      pattern: "project\\.task.*create"
    - from: "segment.id"
      to: "task.segment_id"
      via: "Direct assignment in values dict"
      pattern: "'segment_id'.*segment\\.id"
---

<objective>
Implement automatic hierarchical task creation when sale order is confirmed

Purpose: This is the core automation that converts budget segment structure into project task hierarchy, enabling seamless transition from quotation to project execution without manual task creation.

Output: Extended sale.order model with action_confirm() override that creates tasks from segments level-by-level, maintaining hierarchy, with idempotence and error isolation.
</objective>

<execution_context>
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juanmanuelojedagarcia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-automated-task-creation/04-CONTEXT.md
@.planning/phases/04-automated-task-creation/04-RESEARCH.md
@addons/spora_segment/models/sale_order.py
@addons/spora_segment/models/sale_order_segment.py
@addons/spora_segment/models/project_task.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement action_confirm override with segment-to-task conversion</name>
  <files>addons/spora_segment/models/sale_order.py</files>
  <action>
Extend the existing sale.order model (already has segment_ids One2many and segment_count computed field) with:

**1. Add import for logging:**
```python
import logging
_logger = logging.getLogger(__name__)
```

**2. Override action_confirm():**
```python
def action_confirm(self):
    """Override to create hierarchical tasks from segments before native flow."""
    # CRITICAL: Create segment tasks BEFORE super() call
    for order in self:
        if order.segment_ids:
            order._create_segment_tasks()

    # Native Odoo flow: create project, handle service products, etc.
    return super().action_confirm()
```

**3. Add _get_or_create_project() method:**
- Use Odoo's native project resolution
- Return the project linked to the sale order (via sale_line_id)
- Handle case where project doesn't exist yet (let Odoo create it)
- For now, search for existing project linked to order via order lines:
```python
def _get_or_create_project(self):
    """Get project for this sale order, or None if doesn't exist yet."""
    self.ensure_one()
    # Find project linked via any order line with service product
    project = self.env['project.project'].search([
        ('sale_line_id.order_id', '=', self.id)
    ], limit=1)
    if not project:
        # Try via tasks (in case tasks created manually)
        task = self.env['project.task'].search([
            ('sale_order_id', '=', self.id)
        ], limit=1)
        if task:
            project = task.project_id
    return project
```

**4. Add _create_segment_tasks() method:**
- Check if segments exist
- Get or create project (if no project, skip task creation - Odoo will handle later)
- Process segments level-by-level (BFS: level 1, then 2, then 3, then 4)
- Track segment.id -> task.id mapping for parent_id resolution
- Check idempotence (if task with segment_id exists, reuse it, don't create duplicate)
- Use savepoint isolation for each task creation

**5. Add _prepare_task_values() helper:**
- Build task creation dict with: name, project_id, segment_id, description, planned_hours, partner_id, company_id, sequence
- If segment has parent_id and parent's task exists in mapping, set parent_id
- Calculate planned_hours as sum of line_ids.product_uom_qty

**6. Add _format_products_description() helper:**
- Return empty string if no lines
- Format as:
```
Productos incluidos:
â€¢ Product Name (qty.00 unit)
  Product description (if exists)
```
- Use plain text with newlines (compatible with Text and Html fields)

**7. Add _create_task_with_savepoint() method:**
- Wrap task creation in `with self.env.cr.savepoint():`
- Log success at info level
- Catch Exception, log error with exc_info=True, return None
- Return created task on success

**Important implementation notes (from 04-RESEARCH.md):**
- Execute conversion BEFORE super().action_confirm() to control flow
- Process level 1 segments first, then level 2, etc. (guarantees parent_id exists)
- Idempotence check: search for existing task with same segment_id before creating
- Savepoints prevent cascading rollbacks (one failure doesn't block others)
- Do NOT use recursion (Python limit), use iteration by level
  </action>
  <verify>
1. Module upgrades without errors:
```bash
docker compose exec odoo odoo --config=/etc/odoo/odoo.conf -d odoo --update=spora_segment --stop-after-init
```

2. Python syntax check:
```bash
docker compose exec odoo python3 -m py_compile /mnt/extra-addons/spora_segment/models/sale_order.py
```
  </verify>
  <done>
- sale_order.py contains action_confirm() override calling _create_segment_tasks() before super()
- _create_segment_tasks() processes segments level-by-level with idempotence checks
- _prepare_task_values() builds task dict with segment data (name, description, hours, segment_id)
- _format_products_description() formats product list for task description
- _create_task_with_savepoint() wraps creation in savepoint with error logging
- Module upgrades cleanly in Docker
  </done>
</task>

<task type="auto">
  <name>Task 2: Manual integration verification via Odoo shell</name>
  <files>none</files>
  <action>
Verify the implementation works correctly using Odoo shell in Docker.

**1. Start Odoo shell:**
```bash
docker compose exec odoo odoo shell --config=/etc/odoo/odoo.conf -d odoo
```

**2. Create test data and verify task creation:**
```python
# Setup: Find or create test sale order with segments
Order = env['sale.order']
Segment = env['sale.order.segment']
Task = env['project.task']
Product = env['product.product']

# Get existing service product or create one
product = Product.search([('type', '=', 'service')], limit=1)
if not product:
    product = Product.create({'name': 'Test Service', 'type': 'service'})

# Get existing partner
partner = env['res.partner'].search([], limit=1)

# Create sale order
order = Order.create({
    'partner_id': partner.id,
})

# Create hierarchical segments
seg_root = Segment.create({
    'name': 'Root Segment',
    'order_id': order.id,
})
seg_child = Segment.create({
    'name': 'Child Segment',
    'order_id': order.id,
    'parent_id': seg_root.id,
})

# Add order line to root segment
env['sale.order.line'].create({
    'order_id': order.id,
    'product_id': product.id,
    'product_uom_qty': 5.0,
    'segment_id': seg_root.id,
})

# Add order line to child segment
env['sale.order.line'].create({
    'order_id': order.id,
    'product_id': product.id,
    'product_uom_qty': 3.0,
    'segment_id': seg_child.id,
})

env.cr.commit()

# Verify initial state
print(f"Order: {order.name}")
print(f"Segments: {order.segment_ids.mapped('name')}")
print(f"Tasks before confirm: {Task.search([('segment_id', 'in', order.segment_ids.ids)])}")

# Confirm order
order.action_confirm()
env.cr.commit()

# Verify tasks created
tasks = Task.search([('segment_id', 'in', order.segment_ids.ids)])
print(f"Tasks after confirm: {len(tasks)}")
for task in tasks:
    print(f"  Task: {task.name}, segment: {task.segment_id.name}, parent: {task.parent_id.name if task.parent_id else 'None'}, hours: {task.planned_hours}")
    print(f"    Description: {task.description[:100] if task.description else 'None'}...")

# Verify hierarchy
root_task = Task.search([('segment_id', '=', seg_root.id)])
child_task = Task.search([('segment_id', '=', seg_child.id)])
print(f"Root task parent_id: {root_task.parent_id.id if root_task.parent_id else None}")
print(f"Child task parent_id: {child_task.parent_id.id if child_task.parent_id else None}")
assert child_task.parent_id.id == root_task.id, "Child task should have root task as parent"
print("Hierarchy verification: PASSED")

# Verify idempotence: re-confirm and check no duplicates
original_task_count = len(tasks)
order.action_confirm()
env.cr.commit()
tasks_after_reconfirm = Task.search([('segment_id', 'in', order.segment_ids.ids)])
print(f"Tasks after re-confirm: {len(tasks_after_reconfirm)}")
assert len(tasks_after_reconfirm) == original_task_count, "Re-confirm should not create duplicates"
print("Idempotence verification: PASSED")

print("\\n=== ALL VERIFICATIONS PASSED ===")
```

**3. Verify output shows:**
- 2 tasks created (one per segment)
- Child task's parent_id equals root task's id
- Re-confirm doesn't create duplicates
- Task descriptions contain product information
- Task planned_hours match product quantities

**Note:** If project doesn't exist yet (no service products with service_tracking), tasks may not be created in this test. That's expected - Odoo creates project on confirm for service products. Test should still show idempotence and hierarchy logic when project exists.
  </action>
  <verify>
Shell test shows:
- Tasks created for each segment after confirm
- Child task has correct parent_id pointing to root task
- Re-confirm produces same task count (idempotent)
- Task names match segment names
- Task descriptions include product information
  </verify>
  <done>
- Odoo shell test passes showing task hierarchy created from segments
- Idempotence verified (re-confirm doesn't duplicate tasks)
- Hierarchy verified (child task.parent_id = root task.id)
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Module health:**
   - `docker compose exec odoo odoo --config=/etc/odoo/odoo.conf -d odoo --update=spora_segment --stop-after-init` exits 0

2. **Core functionality:**
   - Confirming sale order with segments creates tasks
   - Task hierarchy mirrors segment hierarchy
   - Task names match segment names
   - Task descriptions contain product listings
   - Task planned_hours equals sum of product quantities
   - Task segment_id links back to segment

3. **Idempotence:**
   - Re-confirming sale order doesn't create duplicate tasks

4. **Error isolation:**
   - Savepoint pattern in place (tested in Plan 02 with intentional failures)
</verification>

<success_criteria>
- [ ] sale_order.py contains ~100+ lines with full implementation
- [ ] action_confirm() calls _create_segment_tasks() before super()
- [ ] Level-by-level processing ensures parent tasks exist before children
- [ ] Idempotence check prevents duplicate task creation
- [ ] Savepoint wrapping isolates task creation failures
- [ ] Shell test shows correct task hierarchy and data transfer
- [ ] Module upgrades without errors in Docker
</success_criteria>

<output>
After completion, create `.planning/phases/04-automated-task-creation/04-01-SUMMARY.md`
</output>
